<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>五线谱绘制工具 - 钢琴键盘版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <style>
    /* 保留所有原始样式 */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background-color: #f1f5f9;
      overflow: hidden;
      touch-action: manipulation;
    }
    
    .menu-item {
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .menu-item:hover {
      background-color: #f1f5f9;
    }
    
    .dropdown-menu {
      position: absolute;
      right: 0;
      margin-top: 0.5rem;
      width: 12rem;
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 50;
    }
    
    .dropdown-open .dropdown-menu {
      display: block;
    }
    
    .submenu-item {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .submenu-item:hover {
      background-color: #f1f5f9;
    }
    
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .modal-visible .modal-backdrop {
      display: flex;
      opacity: 1;
    }
    
    .modal-content {
      background-color: white;
      border-radius: 0.75rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      width: 100%;
      max-width: 24rem;
      margin: 0 1rem;
      transform: scale(0.95);
      opacity: 0;
      transition: all 0.3s;
    }
    
    .modal-visible .modal-content {
      transform: scale(1);
      opacity: 1;
    }
    
    .slider-input {
      width: 100%;
      height: 0.5rem;
      background-color: #e2e8f0;
      border-radius: 0.5rem;
      appearance: none;
      cursor: pointer;
      accent-color: #2563eb;
    }
    
    .slider-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.875rem;
      font-weight: 500;
      color: #64748b;
      margin-bottom: 0.5rem;
    }
    
    .slider-wrapper {
      margin-bottom: 1.5rem;
    }
    
    .btn-primary {
      background-color: #2563eb;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      transition: background-color 0.2s;
      border: none;
      cursor: pointer;
    }
    
    .btn-primary:hover {
      background-color: rgba(37, 99, 235, 0.9);
    }
    
    .position-display {
      position: absolute;
      bottom: 1rem;
      left: 0;
      right: 0;
      margin: 0 auto;
      width: 95%;
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(4px);
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      font-size: 1.125rem;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #000000;
      z-index: 10;
    }
    
    .mouse-position-display {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(4px);
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.3s;
      color: #000000;
      z-index: 10;
    }
    
    .number-input {
      width: 5rem;
      padding: 0.25rem;
      border: 1px solid #d1d5db;
      border-radius: 0.25rem;
      text-align: center;
      font-size: 0.875rem;
    }
    
    .input-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .snap-indicator {
      position: absolute;
      width: 1rem;
      height: 1rem;
      background-color: #ef4444;
      border-radius: 50%;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .no-zoom {
      touch-action: manipulation;
    }
    
    .pitch-display {
      font-weight: 700;
      min-width: 6rem;
    }
    
    .position-text {
      color: #000000;
    }
    
    .random-button {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      background-color: #2563eb;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
      z-index: 10;
    }
    
    .random-button:hover {
      background-color: rgba(37, 99, 235, 0.9);
    }
    
    .piano-container {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 150px;
      background-color: #333;
      border-top: 2px solid #555;
      overflow: hidden;
      user-select: none;
    }
    
    .piano-keys {
      position: relative;
      height: 100%;
      width: 100%;
      overflow-x: auto;
    }
    
    .white-key {
      position: absolute;
      top: 0;
      width: 40px;
      height: 100%;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 0 0 5px 5px;
      cursor: pointer;
      z-index: 1;
    }
    
    .white-key.active {
      background-color: #4ade80;
    }
    
    .white-key.midi-active {
      background-color: #4ade80;
    }
    
    .black-key {
      position: absolute;
      top: 0;
      width: 24px;
      height: 60%;
      background-color: black;
      border-radius: 0 0 3px 3px;
      cursor: pointer;
      z-index: 2;
    }
    
    .black-key.active {
      background-color: #4ade80;
    }
    
    .black-key.midi-active {
      background-color: #4ade80;
    }
    
    .key-label {
      position: absolute;
      bottom: 5px;
      width: 100%;
      text-align: center;
      font-size: 10px;
      color: #333;
      pointer-events: none;
    }
    
    .black-key .key-label {
      color: white;
    }
    
    .central-c-label {
      font-weight: bold;
      color: #000 !important;
    }
    
    .feedback-display {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(4px);
      padding: 1rem 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      font-size: 1.5rem;
      font-weight: 600;
      color: #000000;
      z-index: 20;
      display: none;
    }
    
    .piano-drag-handle {
      position: absolute;
      top: -20px;
      left: 0;
      width: 100%;
      height: 30px;
      background-color: rgba(100, 100, 255, 0.5);
      cursor: grab;
      z-index: 5;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      border-radius: 5px 5px 0 0;
    }
    
    .piano-drag-handle:active {
      cursor: grabbing;
      background-color: rgba(80, 80, 255, 0.7);
    }
    
    .piano-zoomable {
      transform-origin: center center;
      transition: transform 0.1s ease-out;
    }
    
    .midi-status {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(4px);
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.3s;
      color: #000000;
      z-index: 10;
    }
    
    .midi-connected {
      color: #10b981;
    }
    
    .midi-disconnected {
      color: #ef4444;
    }
    
    /* 不重复历史记录显示样式 */
    .non-repeat-history {
      position: absolute;
      bottom: 5rem;
      left: 0;
      right: 0;
      margin: 0 auto;
      width: 95%;
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(4px);
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s;
      color: #000000;
      z-index: 10;
      max-height: 120px;
      overflow-y: auto;
    }
    
    .history-title {
      font-weight: bold;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      color: #4b5563;
    }
    
    .history-items {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .history-item {
      background-color: #e5e7eb;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.875rem;
    }
    
    .history-item.current {
      background-color: #3b82f6;
      color: white;
    }
    
    .history-item.old {
      background-color: #d1d5db;
      color: #6b7280;
    }
    
    @media (max-width: 768px) {
      .menu-item span {
        display: none;
      }
      
      .menu-item i {
        margin-right: 0;
      }
      
      .position-display {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
        font-size: 1rem;
      }
      
      .random-button {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
      }
      
      .piano-drag-handle {
        height: 40px;
        font-size: 14px;
      }
      
      .midi-status {
        top: 4rem;
        left: 1rem;
        right: auto;
      }
      
      .non-repeat-history {
        bottom: 6rem;
        max-height: 80px;
      }
    }
  </style>
</head>
<body class="no-zoom">
  <!-- 顶部菜单栏 -->
  <header class="bg-white shadow-sm z-30 relative">
    <div class="container mx-auto">
      <nav class="flex items-center justify-between h-16 px-4">
        <div class="flex items-center">
          <i class="fa fa-music text-blue-600 text-xl mr-2"></i>
          <span class="font-bold text-gray-800 text-lg truncate">五线谱绘制工具 - 钢琴键盘版</span>
        </div>
        
        <div class="flex items-center space-x-1 relative">
          <!-- 设置下拉菜单 -->
          <div class="relative" id="settings-dropdown">
            <div class="menu-item flex items-center" id="settings-button">
              <i class="fa fa-cog mr-1"></i>
              <span>设置</span>
              <i class="fa fa-chevron-down ml-1 text-xs transition-transform duration-300"></i>
            </div>
            
            <!-- 下拉子菜单 -->
            <div class="dropdown-menu" id="settings-submenu">
              <div class="submenu-item" id="lines-settings-btn">
                <i class="fa fa-sliders mr-1"></i>
                <span>线条设置</span>
              </div>
              <div class="submenu-item" id="clef-settings-btn">
                <i class="fa fa-music mr-1"></i>
                <span>谱号设置</span>
              </div>
              <div class="submenu-item" id="note-settings-btn">
                <i class="fa fa-music mr-1"></i>
                <span>全音符设置</span>
              </div>
              <div class="submenu-item" id="text-settings-btn">
                <i class="fa fa-font mr-1"></i>
                <span>文本设置</span>
              </div>
              <div class="submenu-item" id="piano-settings-btn">
                <i class="fa fa-keyboard-o mr-1"></i>
                <span>钢琴键盘设置</span>
              </div>
              <div class="submenu-item" id="midi-settings-btn">
                <i class="fa fa-plug mr-1"></i>
                <span>MIDI设备设置</span>
              </div>
              <div class="submenu-item" id="random-range-btn">
                <i class="fa fa-random mr-1"></i>
                <span>随机范围设置</span>
              </div>
            </div>
          </div>
          
          <div class="menu-item">
            <i class="fa fa-question-circle mr-1"></i>
            <span>帮助</span>
          </div>
        </div>
      </nav>
    </div>
  </header>
  
  <!-- 主绘图区域 -->
  <main class="h-[calc(100vh-4rem)] relative">
    <canvas id="lines-canvas" class="w-full h-full bg-gray-100 touch-none"></canvas>
    
    <!-- 鼠标位置显示 -->
    <div id="mouse-position-display" class="mouse-position-display">
      鼠标位置: <span id="mouse-position-text">(0, 0)</span>
    </div>
    
    <!-- MIDI状态显示 -->
    <div id="midi-status" class="midi-status midi-disconnected">
      <i class="fa fa-plug mr-2"></i>
      <span id="midi-status-text">MIDI设备未连接</span>
    </div>
    
    <!-- 音符位置显示 -->
    <div id="position-display" class="position-display">
      <span class="pitch-display" id="pitch-text">-</span>
      <span class="position-text" id="position-text">未放置</span>
    </div>
    
    <!-- 不重复历史记录显示 -->
    <div id="non-repeat-history" class="non-repeat-history" style="display: none;">
      <div class="history-title">不重复历史记录:</div>
      <div class="history-items" id="history-items"></div>
    </div>
    
    <!-- 反馈显示 -->
    <div id="feedback-display" class="feedback-display"></div>
    
    <!-- 随机音符按钮 -->
    <button id="random-note-btn" class="random-button">
      <i class="fa fa-random mr-2"></i>随机音符
    </button>
    
    <!-- 吸附指示器 - 只在非拖拽状态下显示 -->
    <div id="snap-indicator" class="snap-indicator"></div>
    
    <!-- 钢琴键盘 -->
    <div id="piano-container" class="piano-container">
      <div id="piano-drag-handle" class="piano-drag-handle">
        <i class="fa fa-arrows-h mr-2"></i>拖拽移动键盘
      </div>
      <div id="piano-keys" class="piano-keys piano-zoomable"></div>
    </div>
  </main>
  
  <!-- 线条参数设置模态框 -->
  <div id="lines-settings-container">
    <div class="modal-backdrop" id="lines-settings-modal">
      <div class="modal-content">
        <h2 class="text-xl font-semibold text-gray-800 mb-5 flex items-center">
          <i class="fa fa-sliders mr-2 text-blue-600"></i>线条参数设置
        </h2>
        
        <!-- 线颜色控制 -->
        <div class="slider-wrapper">
          <label class="slider-label">
            <span>线条颜色</span>
          </label>
          <input 
            type="color" 
            id="color-picker" 
            class="w-full h-10 cursor-pointer"
            value="#000000"
          >
        </div>
        
        <!-- 线间距控制 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>线间距</span>
            <div class="input-group">
              <span id="spacing-value" class="font-mono">25px</span>
              <input type="number" id="spacing-input" class="number-input" min="10" max="100" value="25">
            </div>
          </div>
          <input 
            type="range" 
            id="spacing-slider" 
            class="slider-input"
            min="10" 
            max="100" 
            value="25"
          >
        </div>
        
        <!-- 垂直位置控制 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>垂直位置</span>
            <div class="input-group">
              <span id="position-value" class="font-mono">195px</span>
              <input type="number" id="position-input" class="number-input" min="50" max="800" value="195">
            </div>
          </div>
          <input 
            type="range" 
            id="position-slider" 
            class="slider-input"
            min="50" 
            max="800" 
            value="195"
          >
        </div>
        
        <!-- 线粗细控制 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>线粗细</span>
            <div class="input-group">
              <span id="thickness-value" class="font-mono">2px</span>
              <input type="number" id="thickness-input" class="number-input" min="1" max="10" value="2">
            </div>
          </div>
          <input 
            type="range" 
            id="thickness-slider" 
            class="slider-input"
            min="1" 
            max="10" 
            value="2"
          >
        </div>
        
        <!-- 线长度控制 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>线长度</span>
            <div class="input-group">
              <span id="length-value" class="font-mono">80%</span>
              <input type="number" id="length-input" class="number-input" min="30" max="100" value="80">
            </div>
          </div>
          <input 
            type="range" 
            id="length-slider" 
            class="slider-input"
            min="30" 
            max="100" 
            value="80"
          >
        </div>
        
        <!-- 吸附功能控制 -->
        <div class="slider-wrapper flex items-center justify-between">
          <label class="text-sm font-medium text-gray-600">启用吸附功能</label>
          <input 
            type="checkbox" 
            id="snap-enabled" 
            class="w-5 h-5 accent-blue-600"
            checked
          >
        </div>
        
        <!-- 吸附强度控制 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>吸附强度</span>
            <div class="input-group">
              <span id="snap-strength-value" class="font-mono">25%</span>
              <input type="number" id="snap-strength-input" class="number-input" min="10" max="50" value="25">
            </div>
          </div>
          <input 
            type="range" 
            id="snap-strength-slider" 
            class="slider-input"
            min="10" 
            max="50" 
            value="25"
          >
        </div>
        
        <!-- 按钮区域 -->
        <div class="flex space-x-3 mt-4">
          <button id="lines-reset-btn" class="flex-1 btn-primary bg-gray-600 hover:bg-gray-700">
            <i class="fa fa-refresh mr-2"></i>重置
          </button>
          <button id="lines-close-btn" class="flex-1 btn-primary">
            <i class="fa fa-check mr-2"></i>确定
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 谱号参数设置模态框 -->
  <div id="clef-settings-container">
    <div class="modal-backdrop" id="clef-settings-modal">
      <div class="modal-content">
        <h2 class="text-xl font-semibold text-gray-800 mb-5 flex items-center">
          <i class="fa fa-music mr-2 text-blue-600"></i>高音谱号设置
        </h2>
        
        <!-- 谱号显示控制 -->
        <div class="slider-wrapper flex items-center justify-between">
          <label class="text-sm font-medium text-gray-600">显示高音谱号</label>
          <input 
            type="checkbox" 
            id="show-clef" 
            class="w-5 h-5 accent-blue-600"
            checked
          >
        </div>
        
        <!-- 谱号自动吸附控制 -->
        <div class="slider-wrapper flex items-center justify-between">
          <label class="text-sm font-medium text-gray-600">启用谱号自动吸附</label>
          <input 
            type="checkbox" 
            id="clef-auto-snap" 
            class="w-5 h-5 accent-blue-600"
            checked
          >
        </div>
        
        <!-- 谱号大小控制 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>大小比例</span>
            <div class="input-group">
              <span id="clef-size-value" class="font-mono">55%</span>
              <input type="number" id="clef-size-input" class="number-input" min="50" max="200" value="55">
            </div>
          </div>
          <input 
            type="range" 
            id="clef-size-slider" 
            class="slider-input"
            min="50" 
            max="200" 
            value="55"
          >
        </div>
        
        <!-- 按钮区域 -->
        <div class="flex space-x-3 mt-4">
          <button id="clef-reset-btn" class="flex-1 btn-primary bg-gray-600 hover:bg-gray-700">
            <i class="fa fa-refresh mr-2"></i>重置
          </button>
          <button id="clef-close-btn" class="flex-1 btn-primary">
            <i class="fa fa-check mr-2"></i>确定
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 全音符参数设置模态框 -->
  <div id="note-settings-container">
    <div class="modal-backdrop" id="note-settings-modal">
      <div class="modal-content">
        <h2 class="text-xl font-semibold text-gray-800 mb-5 flex items-center">
          <i class="fa fa-music mr-2 text-blue-600"></i>全音符设置
        </h2>
        
        <!-- 全音符显示控制 -->
        <div class="slider-wrapper flex items-center justify-between">
          <label class="text-sm font-medium text-gray-600">显示全音符</label>
          <input 
            type="checkbox" 
            id="show-note" 
            class="w-5 h-5 accent-blue-600"
            checked
          >
        </div>
        
        <!-- 全音符X位置控制 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>水平位置</span>
            <div class="input-group">
              <span id="note-x-value" class="font-mono">400px</span>
              <input type="number" id="note-x-input" class="number-input" min="50" max="800" value="400">
            </div>
          </div>
          <input 
            type="range" 
            id="note-x-slider" 
            class="slider-input"
            min="50" 
            max="800" 
            value="400"
          >
        </div>
        
        <!-- 全音符Y位置控制 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>垂直位置</span>
            <div class="input-group">
              <span id="note-y-value" class="font-mono">200px</span>
              <input type="number" id="note-y-input" class="number-input" min="50" max="500" value="200">
            </div>
          </div>
          <input 
            type="range" 
            id="note-y-slider" 
            class="slider-input"
            min="50" 
            max="500" 
            value="200"
          >
        </div>
        
        <!-- 全音符大小控制（最小比例5%） -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>大小比例</span>
            <div class="input-group">
              <span id="note-size-value" class="font-mono">8%</span>
              <input type="number" id="note-size-input" class="number-input" min="5" max="200" value="8">
            </div>
          </div>
          <input 
            type="range" 
            id="note-size-slider" 
            class="slider-input"
            min="5"
            max="200" 
            value="8"
          >
        </div>
        
        <!-- 按钮区域 -->
        <div class="flex space-x-3 mt-4">
          <button id="note-reset-btn" class="flex-1 btn-primary bg-gray-600 hover:bg-gray-700">
            <i class="fa fa-refresh mr-2"></i>重置
          </button>
          <button id="note-close-btn" class="flex-1 btn-primary">
            <i class="fa fa-check mr-2"></i>确定
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 文本参数设置模态框 -->
  <div id="text-settings-container">
    <div class="modal-backdrop" id="text-settings-modal">
      <div class="modal-content">
        <h2 class="text-xl font-semibold text-gray-800 mb-5 flex items-center">
          <i class="fa fa-font mr-2 text-blue-600"></i>文本设置
        </h2>
        
        <!-- 文本颜色控制 -->
        <div class="slider-wrapper">
          <label class="slider-label">
            <span>文本颜色</span>
          </label>
          <input 
            type="color" 
            id="text-color-picker" 
            class="w-full h-10 cursor-pointer"
            value="#000000"
          >
        </div>
        
        <!-- 文本大小控制 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>文本大小</span>
            <div class="input-group">
              <span id="text-size-value" class="font-mono">19px</span>
              <input type="number" id="text-size-input" class="number-input" min="8" max="30" value="19">
            </div>
          </div>
          <input 
            type="range" 
            id="text-size-slider" 
            class="slider-input"
            min="8" 
            max="30" 
            value="19"
          >
        </div>
        
        <!-- 文本字体控制 -->
        <div class="slider-wrapper">
          <label class="slider-label">
            <span>文本字体</span>
          </label>
          <select id="text-font-select" class="w-full p-2 border border-gray-300 rounded-lg">
            <option value="Arial, sans-serif">Arial</option>
            <option value="'Microsoft YaHei', sans-serif">微软雅黑</option>
            <option value="'SimSun', serif">宋体</option>
            <option value="'SimHei', sans-serif">黑体</option>
            <option value="'KaiTi', serif">楷体</option>
          </select>
        </div>
        
        <!-- 显示位置显示框控制 -->
        <div class="slider-wrapper flex items-center justify-between">
          <label class="text-sm font-medium text-gray-600">显示位置显示框</label>
          <input 
            type="checkbox" 
            id="show-position-display" 
            class="w-5 h-5 accent-blue-600"
            checked
          >
        </div>
        
        <!-- 显示随机按钮控制 -->
        <div class="slider-wrapper flex items-center justify-between">
          <label class="text-sm font-medium text-gray-600">显示随机按钮</label>
          <input 
            type="checkbox" 
            id="show-random-button" 
            class="w-5 h-5 accent-blue-600"
            checked
          >
        </div>
        
        <!-- 显示不重复历史记录控制 -->
        <div class="slider-wrapper flex items-center justify-between">
          <label class="text-sm font-medium text-gray-600">显示不重复历史记录</label>
          <input 
            type="checkbox" 
            id="show-non-repeat-history" 
            class="w-5 h-5 accent-blue-600"
            checked
          >
        </div>
        
        <!-- 按钮区域 -->
        <div class="flex space-x-3 mt-4">
          <button id="text-reset-btn" class="flex-1 btn-primary bg-gray-600 hover:bg-gray-700">
            <i class="fa fa-refresh mr-2"></i>重置
          </button>
          <button id="text-close-btn" class="flex-1 btn-primary">
            <i class="fa fa-check mr-2"></i>确定
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 钢琴键盘设置模态框 -->
  <div id="piano-settings-container">
    <div class="modal-backdrop" id="piano-settings-modal">
      <div class="modal-content">
        <h2 class="text-xl font-semibold text-gray-800 mb-5 flex items-center">
          <i class="fa fa-keyboard-o mr-2 text-blue-600"></i>钢琴键盘设置
        </h2>
        
        <!-- 钢琴键盘显示控制 -->
        <div class="slider-wrapper flex items-center justify-between">
          <label class="text-sm font-medium text-gray-600">显示钢琴键盘</label>
          <input 
            type="checkbox" 
            id="show-piano" 
            class="w-5 h-5 accent-blue-600"
            checked
          >
        </div>
        
        <!-- 钢琴键盘高度控制 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>键盘高度</span>
            <div class="input-group">
              <span id="piano-height-value" class="font-mono">150px</span>
              <input type="number" id="piano-height-input" class="number-input" min="80" max="300" value="150">
            </div>
          </div>
          <input 
            type="range" 
            id="piano-height-slider" 
            class="slider-input"
            min="80" 
            max="300" 
            value="150"
          >
        </div>
        
        <!-- 钢琴键盘位置控制 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>垂直位置</span>
            <div class="input-group">
              <span id="piano-position-value" class="font-mono">0px</span>
              <input type="number" id="piano-position-input" class="number-input" min="0" max="500" value="0">
            </div>
          </div>
          <input 
            type="range" 
            id="piano-position-slider" 
            class="slider-input"
            min="0" 
            max="500" 
            value="0"
          >
        </div>
        
        <!-- 钢琴键盘水平位置控制 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>水平位置</span>
            <div class="input-group">
              <span id="piano-horizontal-value" class="font-mono">0px</span>
              <input type="number" id="piano-horizontal-input" class="number-input" min="-500" max="500" value="0">
            </div>
          </div>
          <input 
            type="range" 
            id="piano-horizontal-slider" 
            class="slider-input"
            min="-500" 
            max="500" 
            value="0"
          >
        </div>
        
        <!-- 琴键宽度控制 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>白键宽度</span>
            <div class="input-group">
              <span id="piano-key-width-value" class="font-mono">40px</span>
              <input type="number" id="piano-key-width-input" class="number-input" min="20" max="80" value="40">
            </div>
          </div>
          <input 
            type="range" 
            id="piano-key-width-slider" 
            class="slider-input"
            min="20" 
            max="80" 
            value="40"
          >
        </div>
        
        <!-- 显示琴键组数控制 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>显示琴键组数</span>
            <div class="input-group">
              <span id="piano-groups-value" class="font-mono">7组</span>
              <input type="number" id="piano-groups-input" class="number-input" min="1" max="7" value="7">
            </div>
          </div>
          <input 
            type="range" 
            id="piano-groups-slider" 
            class="slider-input"
            min="1" 
            max="7" 
            value="7"
          >
        </div>
        
        <!-- 显示音名控制 -->
        <div class="slider-wrapper flex items-center justify-between">
          <label class="text-sm font-medium text-gray-600">显示所有音名</label>
          <input 
            type="checkbox" 
            id="show-all-names" 
            class="w-5 h-5 accent-blue-600"
            checked
          >
        </div>
        
        <!-- 仅显示中央C控制 -->
        <div class="slider-wrapper flex items-center justify-between">
          <label class="text-sm font-medium text-gray-600">仅显示中央C</label>
          <input 
            type="checkbox" 
            id="show-only-central-c" 
            class="w-5 h-5 accent-blue-600"
          >
        </div>
        
        <!-- 启用双指缩放控制 -->
        <div class="slider-wrapper flex items-center justify-between">
          <label class="text-sm font-medium text-gray-600">启用双指缩放</label>
          <input 
            type="checkbox" 
            id="enable-pinch-zoom" 
            class="w-5 h-5 accent-blue-600"
            checked
          >
        </div>
        
        <!-- 按钮区域 -->
        <div class="flex space-x-3 mt-4">
          <button id="piano-reset-btn" class="flex-1 btn-primary bg-gray-600 hover:bg-gray-700">
            <i class="fa fa-refresh mr-2"></i>重置
          </button>
          <button id="piano-close-btn" class="flex-1 btn-primary">
            <i class="fa fa-check mr-2"></i>确定
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MIDI设备设置模态框 -->
  <div id="midi-settings-container">
    <div class="modal-backdrop" id="midi-settings-modal">
      <div class="modal-content">
        <h2 class="text-xl font-semibold text-gray-800 mb-5 flex items-center">
          <i class="fa fa-plug mr-2 text-blue-600"></i>MIDI设备设置
        </h2>
        
        <!-- MIDI设备选择 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>选择MIDI设备</span>
          </div>
          <select id="midi-device-select" class="w-full p-2 border border-gray-300 rounded-lg">
            <option value="">-- 请选择MIDI设备 --</option>
          </select>
        </div>
        
        <!-- MIDI设备状态 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>设备状态</span>
            <span id="midi-device-status" class="text-sm font-mono midi-disconnected">未连接</span>
          </div>
        </div>
        
        <!-- MIDI音符显示 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>最近MIDI音符</span>
            <span id="midi-note-display" class="text-sm font-mono">-</span>
          </div>
        </div>
        
        <!-- 启用MIDI输入控制 -->
        <div class="slider-wrapper flex items-center justify-between">
          <label class="text-sm font-medium text-gray-600">启用MIDI输入</label>
          <input 
            type="checkbox" 
            id="enable-midi-input" 
            class="w-5 h-5 accent-blue-600"
          >
        </div>
        
        <!-- MIDI音符对比控制 -->
        <div class="slider-wrapper flex items-center justify-between">
          <label class="text-sm font-medium text-gray-600">启用MIDI音符对比</label>
          <input 
            type="checkbox" 
            id="midi-note-compare" 
            class="w-5 h-5 accent-blue-600"
            checked
          >
        </div>
        
        <!-- 按钮区域 -->
        <div class="flex space-x-3 mt-4">
          <button id="midi-refresh-btn" class="flex-1 btn-primary bg-gray-600 hover:bg-gray-700">
            <i class="fa fa-refresh mr-2"></i>刷新设备
          </button>
          <button id="midi-close-btn" class="flex-1 btn-primary">
            <i class="fa fa-check mr-2"></i>确定
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 随机范围设置模态框 -->
  <div id="random-range-container">
    <div class="modal-backdrop" id="random-range-modal">
      <div class="modal-content">
        <h2 class="text-xl font-semibold text-gray-800 mb-5 flex items-center">
          <i class="fa fa-random mr-2 text-blue-600"></i>随机音符范围设置
        </h2>
        
        <!-- 最小位置设置 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>最小位置</span>
            <div class="input-group">
              <span id="min-position-value" class="font-mono">下加八线</span>
            </div>
          </div>
          <select id="min-position-select" class="w-full p-2 border border-gray-300 rounded-lg">
            <option value="-16">下加八线</option>
            <option value="-15">下加八间</option>
            <option value="-14">下加七线</option>
            <option value="-13">下加七间</option>
            <option value="-12">下加六线</option>
            <option value="-11">下加六间</option>
            <option value="-10">下加五线</option>
            <option value="-9">下加五间</option>
            <option value="-8">下加四线</option>
            <option value="-7">下加四间</option>
            <option value="-6">下加三线</option>
            <option value="-5">下加三间</option>
            <option value="-4">下加二线</option>
            <option value="-3">下加二间</option>
            <option value="-2">下加一线</option>
            <option value="-1">下加一间</option>
            <option value="0">第一线</option>
            <option value="1">第一间</option>
            <option value="2">第二线</option>
            <option value="3">第二间</option>
            <option value="4">第三线</option>
            <option value="5">第三间</option>
            <option value="6">第四线</option>
            <option value="7">第四间</option>
            <option value="8">第五线</option>
            <option value="9">上加一间</option>
            <option value="10">上加一线</option>
            <option value="11">上加二间</option>
            <option value="12">上加二线</option>
            <option value="13">上加三间</option>
            <option value="14">上加三线</option>
            <option value="15">上加四间</option>
            <option value="16">上加四线</option>
            <option value="17">上加五间</option>
            <option value="18">上加五线</option>
            <option value="19">上加六间</option>
            <option value="20">上加六线</option>
            <option value="21">上加七间</option>
            <option value="22">上加七线</option>
            <option value="23">上加八间</option>
            <option value="24">上加八线</option>
          </select>
        </div>
        
        <!-- 最大位置设置 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>最大位置</span>
            <div class="input-group">
              <span id="max-position-value" class="font-mono">上加八线</span>
            </div>
          </div>
          <select id="max-position-select" class="w-full p-2 border border-gray-300 rounded-lg">
            <option value="-16">下加八线</option>
            <option value="-15">下加八间</option>
            <option value="-14">下加七线</option>
            <option value="-13">下加七间</option>
            <option value="-12">下加六线</option>
            <option value="-11">下加六间</option>
            <option value="-10">下加五线</option>
            <option value="-9">下加五间</option>
            <option value="-8">下加四线</option>
            <option value="-7">下加四间</option>
            <option value="-6">下加三线</option>
            <option value="-5">下加三间</option>
            <option value="-4">下加二线</option>
            <option value="-3">下加二间</option>
            <option value="-2">下加一线</option>
            <option value="-1">下加一间</option>
            <option value="0">第一线</option>
            <option value="1">第一间</option>
            <option value="2">第二线</option>
            <option value="3">第二间</option>
            <option value="4">第三线</option>
            <option value="5">第三间</option>
            <option value="6">第四线</option>
            <option value="7">第四间</option>
            <option value="8">第五线</option>
            <option value="9">上加一间</option>
            <option value="10">上加一线</option>
            <option value="11">上加二间</option>
            <option value="12">上加二线</option>
            <option value="13">上加三间</option>
            <option value="14">上加三线</option>
            <option value="15">上加四间</option>
            <option value="16">上加四线</option>
            <option value="17">上加五间</option>
            <option value="18">上加五线</option>
            <option value="19">上加六间</option>
            <option value="20">上加六线</option>
            <option value="21">上加七间</option>
            <option value="22">上加七线</option>
            <option value="23">上加八间</option>
            <option value="24" selected>上加八线</option>
          </select>
        </div>
        
        <!-- 不重复随机音符数量设置 -->
        <div class="slider-wrapper">
          <div class="slider-label">
            <span>不重复随机数量</span>
            <div class="input-group">
              <span id="non-repeat-value" class="font-mono">0</span>
              <input type="number" id="non-repeat-input" class="number-input" min="0" value="0">
            </div>
          </div>
          <input 
            type="range" 
            id="non-repeat-slider" 
            class="slider-input"
            min="0" 
            max="10" 
            value="0"
          >
        </div>
        
        <!-- 按钮区域 -->
        <div class="flex space-x-3 mt-4">
          <button id="random-range-reset-btn" class="flex-1 btn-primary bg-gray-600 hover:bg-gray-700">
            <i class="fa fa-refresh mr-2"></i>重置
          </button>
          <button id="random-range-close-btn" class="flex-1 btn-primary">
            <i class="fa fa-check mr-2"></i>确定
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 获取DOM元素
    const canvas = document.getElementById('lines-canvas');
    const ctx = canvas.getContext('2d');
    
    // 设置下拉菜单相关元素
    const settingsButton = document.getElementById('settings-button');
    const settingsSubmenu = document.getElementById('settings-submenu');
    const settingsDropdown = document.getElementById('settings-dropdown');
    const chevronIcon = settingsButton.querySelector('.fa-chevron-down');
    
    // 线条设置模态框相关元素
    const linesSettingsContainer = document.getElementById('lines-settings-container');
    const linesSettingsModal = document.getElementById('lines-settings-modal');
    const linesSettingsBtn = document.getElementById('lines-settings-btn');
    const linesCloseBtn = document.getElementById('lines-close-btn');
    const linesResetBtn = document.getElementById('lines-reset-btn');
    const snapEnabledCheckbox = document.getElementById('snap-enabled');
    const snapStrengthSlider = document.getElementById('snap-strength-slider');
    const snapStrengthValue = document.getElementById('snap-strength-value');
    const snapStrengthInput = document.getElementById('snap-strength-input');
    
    // 谱号设置模态框相关元素
    const clefSettingsContainer = document.getElementById('clef-settings-container');
    const clefSettingsModal = document.getElementById('clef-settings-modal');
    const clefSettingsBtn = document.getElementById('clef-settings-btn');
    const clefCloseBtn = document.getElementById('clef-close-btn');
    const clefResetBtn = document.getElementById('clef-reset-btn');
    const showClefCheckbox = document.getElementById('show-clef');
    const clefAutoSnapCheckbox = document.getElementById('clef-auto-snap');
    const clefSizeSlider = document.getElementById('clef-size-slider');
    const clefSizeValue = document.getElementById('clef-size-value');
    const clefSizeInput = document.getElementById('clef-size-input');
    
    // 全音符设置模态框相关元素
    const noteSettingsContainer = document.getElementById('note-settings-container');
    const noteSettingsModal = document.getElementById('note-settings-modal');
    const noteSettingsBtn = document.getElementById('note-settings-btn');
    const noteCloseBtn = document.getElementById('note-close-btn');
    const noteResetBtn = document.getElementById('note-reset-btn');
    const showNoteCheckbox = document.getElementById('show-note');
    const noteXSlider = document.getElementById('note-x-slider');
    const noteXValue = document.getElementById('note-x-value');
    const noteXInput = document.getElementById('note-x-input');
    const noteYSlider = document.getElementById('note-y-slider');
    const noteYValue = document.getElementById('note-y-value');
    const noteYInput = document.getElementById('note-y-input');
    const noteSizeSlider = document.getElementById('note-size-slider');
    const noteSizeValue = document.getElementById('note-size-value');
    const noteSizeInput = document.getElementById('note-size-input');
    
    // 文本设置模态框相关元素
    const textSettingsContainer = document.getElementById('text-settings-container');
    const textSettingsModal = document.getElementById('text-settings-modal');
    const textSettingsBtn = document.getElementById('text-settings-btn');
    const textCloseBtn = document.getElementById('text-close-btn');
    const textResetBtn = document.getElementById('text-reset-btn');
    const textColorPicker = document.getElementById('text-color-picker');
    const textSizeSlider = document.getElementById('text-size-slider');
    const textSizeValue = document.getElementById('text-size-value');
    const textFontSelect = document.getElementById('text-font-select');
    const textSizeInput = document.getElementById('text-size-input');
    const showPositionDisplayCheckbox = document.getElementById('show-position-display');
    const showRandomButtonCheckbox = document.getElementById('show-random-button');
    const showNonRepeatHistoryCheckbox = document.getElementById('show-non-repeat-history');
    
    // 钢琴键盘设置模态框相关元素
    const pianoSettingsContainer = document.getElementById('piano-settings-container');
    const pianoSettingsModal = document.getElementById('piano-settings-modal');
    const pianoSettingsBtn = document.getElementById('piano-settings-btn');
    const pianoCloseBtn = document.getElementById('piano-close-btn');
    const pianoResetBtn = document.getElementById('piano-reset-btn');
    const showPianoCheckbox = document.getElementById('show-piano');
    const pianoHeightSlider = document.getElementById('piano-height-slider');
    const pianoHeightValue = document.getElementById('piano-height-value');
    const pianoHeightInput = document.getElementById('piano-height-input');
    const pianoPositionSlider = document.getElementById('piano-position-slider');
    const pianoPositionValue = document.getElementById('piano-position-value');
    const pianoPositionInput = document.getElementById('piano-position-input');
    const pianoHorizontalSlider = document.getElementById('piano-horizontal-slider');
    const pianoHorizontalValue = document.getElementById('piano-horizontal-value');
    const pianoHorizontalInput = document.getElementById('piano-horizontal-input');
    const pianoKeyWidthSlider = document.getElementById('piano-key-width-slider');
    const pianoKeyWidthValue = document.getElementById('piano-key-width-value');
    const pianoKeyWidthInput = document.getElementById('piano-key-width-input');
    const pianoGroupsSlider = document.getElementById('piano-groups-slider');
    const pianoGroupsValue = document.getElementById('piano-groups-value');
    const pianoGroupsInput = document.getElementById('piano-groups-input');
    const showAllNamesCheckbox = document.getElementById('show-all-names');
    const showOnlyCentralCCheckbox = document.getElementById('show-only-central-c');
    const enablePinchZoomCheckbox = document.getElementById('enable-pinch-zoom');
    
    // MIDI设置模态框相关元素
    const midiSettingsContainer = document.getElementById('midi-settings-container');
    const midiSettingsModal = document.getElementById('midi-settings-modal');
    const midiSettingsBtn = document.getElementById('midi-settings-btn');
    const midiCloseBtn = document.getElementById('midi-close-btn');
    const midiRefreshBtn = document.getElementById('midi-refresh-btn');
    const midiDeviceSelect = document.getElementById('midi-device-select');
    const midiDeviceStatus = document.getElementById('midi-device-status');
    const midiNoteDisplay = document.getElementById('midi-note-display');
    const enableMidiInputCheckbox = document.getElementById('enable-midi-input');
    const midiNoteCompareCheckbox = document.getElementById('midi-note-compare');
    
    // 随机范围设置模态框相关元素
    const randomRangeContainer = document.getElementById('random-range-container');
    const randomRangeModal = document.getElementById('random-range-modal');
    const randomRangeBtn = document.getElementById('random-range-btn');
    const randomRangeCloseBtn = document.getElementById('random-range-close-btn');
    const randomRangeResetBtn = document.getElementById('random-range-reset-btn');
    const minPositionSelect = document.getElementById('min-position-select');
    const maxPositionSelect = document.getElementById('max-position-select');
    
    // 不重复随机音符数量相关元素
    const nonRepeatSlider = document.getElementById('non-repeat-slider');
    const nonRepeatValue = document.getElementById('non-repeat-value');
    const nonRepeatInput = document.getElementById('non-repeat-input');
    
    // 不重复历史记录显示元素
    const nonRepeatHistory = document.getElementById('non-repeat-history');
    const historyItems = document.getElementById('history-items');
    
    // 线条控制滑块和显示元素
    const spacingSlider = document.getElementById('spacing-slider');
    const spacingValue = document.getElementById('spacing-value');
    const spacingInput = document.getElementById('spacing-input');
    const positionSlider = document.getElementById('position-slider');
    const positionValue = document.getElementById('position-value');
    const positionInput = document.getElementById('position-input');
    const thicknessSlider = document.getElementById('thickness-slider');
    const thicknessValue = document.getElementById('thickness-value');
    const thicknessInput = document.getElementById('thickness-input');
    const lengthSlider = document.getElementById('length-slider');
    const lengthValue = document.getElementById('length-value');
    const lengthInput = document.getElementById('length-input');
    const colorPicker = document.getElementById('color-picker');
    
    // 位置显示元素
    const positionDisplay = document.getElementById('position-display');
    const positionText = document.getElementById('position-text');
    const pitchText = document.getElementById('pitch-text');
    
    // 鼠标位置显示元素
    const mousePositionDisplay = document.getElementById('mouse-position-display');
    const mousePositionText = document.getElementById('mouse-position-text');
    
    // MIDI状态显示元素
    const midiStatus = document.getElementById('midi-status');
    const midiStatusText = document.getElementById('midi-status-text');
    
    // 吸附指示器
    const snapIndicator = document.getElementById('snap-indicator');
    
    // 随机音符按钮
    const randomNoteBtn = document.getElementById('random-note-btn');
    
    // 反馈显示
    const feedbackDisplay = document.getElementById('feedback-display');
    
    // 钢琴键盘元素
    const pianoContainer = document.getElementById('piano-container');
    const pianoKeys = document.getElementById('piano-keys');
    const pianoDragHandle = document.getElementById('piano-drag-handle');
    
    // 高音谱号图片对象和属性
    const clefImage = new Image();
    let clefProps = {
      x: 50,           // 初始X位置
      y: 86,           // 初始Y位置
      size: 55,        // 初始大小比例(%)
      show: true,      // 是否显示
      autoSnap: true,  // 是否自动吸附
      width: 0,        // 图片原始宽度
      height: 0,       // 图片原始高度
      isDragging: false, // 是否正在拖拽
      offsetX: 0,      // 拖拽偏移X
      offsetY: 0       // 拖拽偏移Y
    };
    
    // 全音符图片对象和属性
    const noteImage = new Image();
    let noteProps = {
      x: 400,          // 初始X位置
      y: 200,          // 初始Y位置
      size: 8,         // 初始大小比例(%)
      show: true,      // 是否显示
      width: 0,        // 图片原始宽度
      height: 0,       // 图片原始高度
      isDragging: false, // 是否正在拖拽
      offsetX: 0,      // 拖拽偏移X
      offsetY: 0       // 拖拽偏移Y
    };
    
    // 文本设置属性
    let textProps = {
      color: '#000000',        // 文本颜色
      size: 19,                // 文本大小
      font: 'Arial, sans-serif', // 文本字体
      showPositionDisplay: true, // 显示位置显示框
      showRandomButton: true,    // 显示随机按钮
      showNonRepeatHistory: true // 显示不重复历史记录
    };
    
    // 吸附功能属性
    let snapProps = {
      enabled: true,           // 是否启用吸附功能
      strength: 25,            // 吸附强度（百分比）
      isSnapping: false,       // 当前是否正在吸附
      snapPosition: null       // 当前吸附的位置
    };
    
    // 随机范围属性
    let randomRangeProps = {
      minIndex: -16,           // 最小索引（下加八线）
      maxIndex: 24             // 最大索引（上加八线）
    };
    
    // 不重复随机音符属性
    let nonRepeatProps = {
      count: 0,           // 不重复随机数量，0表示关闭
      maxCount: 0,        // 最大可设置数量（根据范围动态计算）
      history: []         // 已出现的随机音符历史记录
    };
    
    // 钢琴键盘属性
    let pianoProps = {
      show: true,              // 是否显示钢琴键盘
      height: 150,             // 键盘高度
      position: 0,             // 垂直位置
      horizontal: 0,           // 水平位置
      keyWidth: 40,            // 白键宽度
      groups: 7,               // 显示琴键组数
      showAllNames: true,      // 显示所有音名
      showOnlyCentralC: false, // 仅显示中央C
      enablePinchZoom: true,   // 启用双指缩放
      isDragging: false,       // 是否正在拖拽
      keys: [],                // 琴键数组
      offsetX: 0,              // 拖拽偏移X
      offsetY: 0,              // 拖拽偏移Y
      scale: 1,                // 缩放比例
      initialDistance: null    // 双指初始距离
    };
    
    // MIDI设备属性
    let midiProps = {
      enabled: false,          // 是否启用MIDI输入
      access: null,            // MIDI访问对象
      inputs: [],              // MIDI输入设备列表
      selectedInput: null,     // 选中的MIDI输入设备
      noteCompare: true,       // MIDI音符对比功能
      lastNote: null,          // 最后一个MIDI音符
      activeNotes: new Set()   // 当前活动的MIDI音符
    };
    
    // 音名映射关系 - 下加一线为C4，其他按顺序顺延
    const pitchNames = {
      // 下加线部分（索引为负数）
      [-16]: "C2",
      [-15]: "D2",
      [-14]: "E2",
      [-13]: "F2",
      [-12]: "G2",
      [-11]: "A2",
      [-10]: "B2",
      [-9]: "C3",
      [-8]: "D3",
      [-7]: "E3",
      [-6]: "F3",
      [-5]: "G3",
      [-4]: "A3",
      [-3]: "B3",
      [-2]: "C4",
      [-1]: "D4",
      
      // 五线谱部分（索引0-8）
      0: "E4",   // 第一线
      1: "F4",   // 第一间
      2: "G4",   // 第二线
      3: "A4",   // 第二间
      4: "B4",   // 第三线
      5: "C5",   // 第三间
      6: "D5",   // 第四线
      7: "E5",   // 第四间
      8: "F5",  // 第五线
      9: "G5",  // 上加一间
      10: "A5",  // 上加一线
      11: "B5",  // 上加二间
      12: "C6",  // 上加二线
      13: "D6",  // 上加三间
      14: "E6",  // 上加三线
      15: "F6",  // 上加四间
      16: "G6",  // 上加四线
      17: "A6",  // 上加五间
      18: "B6",  // 上加五线
      19: "C7",  // 上加六间
      20: "D7",  // 上加六线
      21: "E7",  // 上加七间
      22: "F7",  // 上加七线
      23: "G7",  // 上加八间
      24: "A7",  // 上加八线
    };
    
    // MIDI音符到音名的映射 (C4 = 60)
    const midiNoteToPitch = {
      21: "A0", 22: "A#0", 23: "B0",
      24: "C1", 25: "C#1", 26: "D1", 27: "D#1", 28: "E1", 29: "F1", 30: "F#1", 31: "G1", 32: "G#1", 33: "A1", 34: "A#1", 35: "B1",
      36: "C2", 37: "C#2", 38: "D2", 39: "D#2", 40: "E2", 41: "F2", 42: "F#2", 43: "G2", 44: "G#2", 45: "A2", 46: "A#2", 47: "B2",
      48: "C3", 49: "C#3", 50: "D3", 51: "D#3", 52: "E3", 53: "F3", 54: "F#3", 55: "G3", 56: "G#3", 57: "A3", 58: "A#3", 59: "B3",
      60: "C4", 61: "C#4", 62: "D4", 63: "D#4", 64: "E4", 65: "F4", 66: "F#4", 67: "G4", 68: "G#4", 69: "A4", 70: "A#4", 71: "B4",
      72: "C5", 73: "C#5", 74: "D5", 75: "D#5", 76: "E5", 77: "F5", 78: "F#5", 79: "G5", 80: "G#5", 81: "A5", 82: "A#5", 83: "B5",
      84: "C6", 85: "C#6", 86: "D6", 87: "D#6", 88: "E6", 89: "F6", 90: "F#6", 91: "G6", 92: "G#6", 93: "A6", 94: "A#6", 95: "B6",
      96: "C7", 97: "C#7", 98: "D7", 99: "D#7", 100: "E7", 101: "F7", 102: "F#7", 103: "G7", 104: "G#7", 105: "A7", 106: "A#7", 107: "B7",
      108: "C8"
    };
    
    // 音名到五线谱位置的映射
    const pitchToStaffPosition = {
      "C2": -16, "D2": -15, "E2": -14, "F2": -13, "G2": -12, "A2": -11, "B2": -10,
      "C3": -9, "D3": -8, "E3": -7, "F3": -6, "G3": -5, "A3": -4, "B3": -3,
      "C4": -2, "D4": -1, "E4": 0, "F4": 1, "G4": 2, "A4": 3, "B4": 4,
      "C5": 5, "D5": 6, "E5": 7, "F5": 8, "G5": 9, "A5": 10, "B5": 11,
      "C6": 12, "D6": 13, "E6": 14, "F6": 15, "G6": 16, "A6": 17, "B6": 18,
      "C7": 19, "D7": 20, "E7": 21, "F7": 22, "G7": 23, "A7": 24
    };
    
    // 线间名称映射
    const lineSpaceNames = {
      // 下加线部分（索引为负数）
      [-16]: "下加八线",
      [-15]: "下加八间",
      [-14]: "下加七线",
      [-13]: "下加七间",
      [-12]: "下加六线",
      [-11]: "下加六间",
      [-10]: "下加五线",
      [-9]: "下加五间",
      [-8]: "下加四线",
      [-7]: "下加四间",
      [-6]: "下加三线",
      [-5]: "下加三间",
      [-4]: "下加二线",
      [-3]: "下加二间",
      [-2]: "下加一线",
      [-1]: "下加一间",
      
      // 五线谱部分（索引0-8）
      0: "第一线",
      1: "第一间",
      2: "第二线",
      3: "第二间",
      4: "第三线",
      5: "第三间",
      6: "第四线",
      7: "第四间",
      8: "第五线",
      
      // 上加线部分（索引9-24）
      9: "上加一间",
      10: "上加一线",
      11: "上加二间",
      12: "上加二线",
      13: "上加三间",
      14: "上加三线",
      15: "上加四间",
      16: "上加四线",
      17: "上加五间",
      18: "上加五线",
      19: "上加六间",
      20: "上加六线",
      21: "上加七间",
      22: "上加七线",
      23: "上加八间",
      24: "上加八线"
    };
    
    // 标准88键钢琴键盘音名映射
    const standardPianoKeyNames = [
      // A0到C8，共88个键
      "A0", "A#0", "B0",
      "C1", "C#1", "D1", "D#1", "E1", "F1", "F#1", "G1", "G#1", "A1", "A#1", "B1",
      "C2", "C#2", "D2", "D#2", "E2", "F2", "F#2", "G2", "G#2", "A2", "A#2", "B2",
      "C3", "C#3", "D3", "D#3", "E3", "F3", "F#3", "G3", "G#3", "A3", "A#3", "B3",
      "C4", "C#4", "D4", "D#4", "E4", "F4", "F#4", "G4", "G#4", "A4", "A#4", "B4",
      "C5", "C#5", "D5", "D#5", "E5", "F5", "F#5", "G5", "G#5", "A5", "A#5", "B5",
      "C6", "C#6", "D6", "D#6", "E6", "F6", "F#6", "G6", "G#6", "A6", "A#6", "B6",
      "C7", "C#7", "D7", "D#7", "E7", "F7", "F#7", "G7", "G#7", "A7", "A#7", "B7",
      "C8"
    ];
    
    // 加载高音谱号图片
    clefImage.src = 'https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/8a33ec8491d24777acab058f26f70a9c.png~tplv-a9rns2rl98-24:720:720.png?rcl=2025092722553727D293D8F79DC2432C68&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1759589738&x-signature=GGFVJqE0kezIYRUPnOPV1Lxx0Dg%3D';
    clefImage.crossOrigin = 'anonymous'; // 允许跨域加载图片
    
    clefImage.onload = function() {
      // 存储图片原始尺寸
      clefProps.width = this.width;
      clefProps.height = this.height;
      drawLines(); // 图片加载完成后重绘
    };
    
    // 处理图片加载错误
    clefImage.onerror = function() {
      console.error('高音谱号图片加载失败，请检查图片链接是否有效');
      alert('高音谱号图片加载失败，部分功能可能无法正常使用');
    };
    
    // 加载全音符图片
    noteImage.src = 'https://p26-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/abf344198b1842028138b905ec3197bf.png~tplv-a9rns2rl98-24:720:720.png?rcl=202509280020167CA68D41E48EBAFAFB82&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1759594816&x-signature=2W9v5AwA4u29aVymspD8KiUxZ9E%3D';
    noteImage.crossOrigin = 'anonymous'; // 允许跨域加载图片
    
    noteImage.onload = function() {
      // 存储图片原始尺寸
      noteProps.width = this.width;
      noteProps.height = this.height;
      drawLines(); // 图片加载完成后重绘
    };
    
    // 处理全音符图片加载错误
    noteImage.onerror = function() {
      console.error('全音符图片加载失败，请检查图片链接是否有效');
      alert('全音符图片加载失败，部分功能可能无法正常使用');
    };
    
    // 下拉菜单控制
    function toggleSettingsMenu() {
      // 切换下拉菜单显示状态
      settingsDropdown.classList.toggle('dropdown-open');
      // 旋转下拉箭头
      chevronIcon.classList.toggle('rotate-180');
    }
    
    function closeSettingsMenu() {
      // 关闭下拉菜单
      settingsDropdown.classList.remove('dropdown-open');
      // 重置下拉箭头
      chevronIcon.classList.remove('rotate-180');
    }
    
    // 关闭所有模态框
    function closeAllModals() {
      linesSettingsContainer.classList.remove('modal-visible');
      clefSettingsContainer.classList.remove('modal-visible');
      noteSettingsContainer.classList.remove('modal-visible');
      textSettingsContainer.classList.remove('modal-visible');
      pianoSettingsContainer.classList.remove('modal-visible');
      midiSettingsContainer.classList.remove('modal-visible');
      randomRangeContainer.classList.remove('modal-visible');
    }
    
    // 模态框控制函数
    function openLinesModal() {
      closeSettingsMenu(); // 关闭子菜单
      closeAllModals();    // 确保其他模态框关闭
      linesSettingsContainer.classList.add('modal-visible');
    }
    
    function closeLinesModal() {
      linesSettingsContainer.classList.remove('modal-visible');
    }
    
    function openClefModal() {
      closeSettingsMenu(); // 关闭子菜单
      closeAllModals();    // 确保其他模态框关闭
      clefSettingsContainer.classList.add('modal-visible');
    }
    
    function closeClefModal() {
      clefSettingsContainer.classList.remove('modal-visible');
    }
    
    function openNoteModal() {
      closeSettingsMenu(); // 关闭子菜单
      closeAllModals();    // 确保其他模态框关闭
      noteSettingsContainer.classList.add('modal-visible');
    }
    
    function closeNoteModal() {
      noteSettingsContainer.classList.remove('modal-visible');
    }
    
    function openTextModal() {
      closeSettingsMenu(); // 关闭子菜单
      closeAllModals();    // 确保其他模态框关闭
      textSettingsContainer.classList.add('modal-visible');
    }
    
    function closeTextModal() {
      textSettingsContainer.classList.remove('modal-visible');
    }
    
    function openPianoModal() {
      closeSettingsMenu(); // 关闭子菜单
      closeAllModals();    // 确保其他模态框关闭
      pianoSettingsContainer.classList.add('modal-visible');
    }
    
    function closePianoModal() {
      pianoSettingsContainer.classList.remove('modal-visible');
    }
    
    function openMidiModal() {
      closeSettingsMenu(); // 关闭子菜单
      closeAllModals();    // 确保其他模态框关闭
      midiSettingsContainer.classList.add('modal-visible');
      refreshMidiDevices();
    }
    
    function closeMidiModal() {
      midiSettingsContainer.classList.remove('modal-visible');
    }
    
    function openRandomRangeModal() {
      closeSettingsMenu(); // 关闭子菜单
      closeAllModals();    // 确保其他模态框关闭
      randomRangeContainer.classList.add('modal-visible');
    }
    
    function closeRandomRangeModal() {
      randomRangeContainer.classList.remove('modal-visible');
    }
    
    // 设置Canvas尺寸以匹配显示大小
    function resizeCanvas() {
      const container = canvas.parentElement;
      const width = container.clientWidth;
      const height = container.clientHeight;
      
      // 考虑高DPI屏幕
      const dpr = window.devicePixelRatio || 1;
      canvas.width = width * dpr;
      canvas.height = height * dpr;
      ctx.scale(dpr, dpr);
      
      // 设置canvas的CSS尺寸
      canvas.style.width = `${width}px`;
      canvas.style.height = `${height}px`;
      
      drawLines();
    }
    
    // 初始设置Canvas尺寸
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    // 更新鼠标位置显示
    function updateMousePosition(x, y) {
      mousePositionText.textContent = `(${Math.round(x)}, ${Math.round(y)})`;
    }
    
    // 重新定义线间名称数组（修正索引计算）
    function getLineOrSpaceName(y) {
      const basePosition = parseInt(positionSlider.value);
      const spacing = parseInt(spacingSlider.value);
      
      // 计算相对于第一条线（最下面）的位置
      const relativeY = basePosition - y;
      
      // 计算线/间索引（每条线和每个间的高度都是spacing/2）
      // 第一线（最下面）索引为0，向上依次增加
      const index = Math.round(relativeY / (spacing / 2));
      
      // 返回对应的名称，如果超出范围则返回"未知位置"
      if (lineSpaceNames.hasOwnProperty(index)) {
        return {
          lineSpaceName: lineSpaceNames[index],
          pitchName: pitchNames[index] || "未知音名",
          index: index
        };
      }
      
      return {
        lineSpaceName: "未知位置",
        pitchName: "未知音名",
        index: index
      };
    }
    
    // 计算谱号自动吸附位置
    function calculateClefPosition() {
      const basePosition = parseInt(positionSlider.value);
      const spacing = parseInt(spacingSlider.value);
      const lengthPercent = parseInt(lengthSlider.value) / 100;
      const displayWidth = canvas.clientWidth;
      
      // 计算线条尺寸和位置
      const lineLength = displayWidth * lengthPercent;
      const startX = (displayWidth - lineLength) / 2;
      
      // 计算五线谱各线位置
      const line1 = basePosition;          // 第一线
      const line3 = basePosition - spacing * 2; // 第三线
      
      // 根据给定的百分比计算谱号位置和大小
      // 谱号上边缘到总高74.2%位置吸附第一线的线中心
      // 谱号上边缘到总高48.7%位置吸附第三线的线中心
      const requiredHeight = (line1 - line3) / (0.742 - 0.487);
      
      // 计算谱号上边缘位置
      const clefTop = line1 - requiredHeight * 0.742;
      
      // 计算谱号宽度（保持原始宽高比）
      const scale = requiredHeight / clefProps.height;
      const requiredWidth = clefProps.width * scale;
      
      // 计算谱号左边缘位置（总长度的5%）
      const clefLeft = startX - 48;
      
      return {
        x: clefLeft,
        y: clefTop,
        width: requiredWidth,
        height: requiredHeight
      };
    }
    
    // 绘制加线
    function drawLedgerLines(noteCenterX, noteCenterY, noteWidth) {
      const basePosition = parseInt(positionSlider.value);
      const spacing = parseInt(spacingSlider.value);
      const thickness = parseInt(thicknessSlider.value);
      const lineColor = colorPicker.value;
      
      // 设置线条样式
      ctx.strokeStyle = lineColor;
      ctx.lineWidth = thickness;
      ctx.lineCap = 'round';
      
      // 计算加线长度（与全音符等宽）
      const ledgerLineLength = noteWidth;
      const ledgerLineStartX = noteCenterX - ledgerLineLength / 2;
      
      // 计算音符相对于第一线的位置（索引）
      const relativeY = basePosition - noteCenterY;
      const index = Math.round(relativeY / (spacing / 2));
      
      // 上加线逻辑（音符在第五线以上，索引>8）
      if (index > 8) {
        // 计算需要显示的上加线数量
        const isOnSpace = index % 2 !== 0; // 是否在间上（奇数索引）
        const maxLedgerLineIndex = isOnSpace ? index - 1 : index; // 最大显示的线索引
        
        // 从第五线（索引8）开始往上绘制加线
        for (let i = 10; i <= maxLedgerLineIndex; i += 2) { // 从上加一线（索引10）开始
          if (i > 24) break; // 限制到上加八线（索引24）
          
          const y = basePosition - i * (spacing / 2);
          ctx.beginPath();
          ctx.moveTo(ledgerLineStartX, y);
          ctx.lineTo(ledgerLineStartX + ledgerLineLength, y);
          ctx.stroke();
        }
      }
      
      // 下加线逻辑（音符在第一线以下，索引<0）
      if (index < 0) {
        // 计算需要显示的下加线数量
        const isOnSpace = index % 2 !== 0; // 是否在间上（奇数索引）
        const minLedgerLineIndex = isOnSpace ? index + 1 : index; // 最小显示的线索引
        
        // 从第一线（索引0）开始往下绘制加线
        for (let i = -2; i >= minLedgerLineIndex; i -= 2) { // 从下加一线（索引-2）开始
          if (i < -16) break; // 限制到下加八线（索引-16）
          
          const y = basePosition - i * (spacing / 2);
          ctx.beginPath();
          ctx.moveTo(ledgerLineStartX, y);
          ctx.lineTo(ledgerLineStartX + ledgerLineLength, y);
          ctx.stroke();
        }
      }
    }
    
    // 更新位置显示的样式
    function updatePositionDisplayStyle() {
      positionDisplay.style.color = textProps.color;
      positionDisplay.style.fontSize = `${textProps.size}px`;
      positionDisplay.style.fontFamily = textProps.font;
      positionDisplay.style.display = textProps.showPositionDisplay ? 'flex' : 'none';
    }
    
    // 更新随机按钮显示
    function updateRandomButtonDisplay() {
      randomNoteBtn.style.display = textProps.showRandomButton ? 'block' : 'none';
    }
    
    // 更新不重复历史记录显示
    function updateNonRepeatHistoryDisplay() {
      nonRepeatHistory.style.display = textProps.showNonRepeatHistory && nonRepeatProps.count > 0 ? 'block' : 'none';
      
      // 更新历史记录内容
      historyItems.innerHTML = '';
      
      if (nonRepeatProps.history.length > 0) {
        // 按时间顺序显示历史记录（最新的在前）
        const reversedHistory = [...nonRepeatProps.history].reverse();
        
        reversedHistory.forEach((index, i) => {
          const pitchName = pitchNames[index];
          if (pitchName) {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            // 当前音符高亮显示
            if (i === 0) {
              historyItem.classList.add('current');
            } else if (i >= 5) { // 超过5个记录，后面的变灰
              historyItem.classList.add('old');
            }
            
            historyItem.textContent = pitchName;
            historyItems.appendChild(historyItem);
          }
        });
      }
    }
    
    // 更新MIDI状态显示
    function updateMidiStatus() {
      if (midiProps.enabled && midiProps.selectedInput) {
        midiStatus.classList.remove('midi-disconnected');
        midiStatus.classList.add('midi-connected');
        midiStatusText.textContent = 'MIDI设备已连接';
      } else {
        midiStatus.classList.remove('midi-connected');
        midiStatus.classList.add('midi-disconnected');
        midiStatusText.textContent = 'MIDI设备未连接';
      }
    }
    
    // 计算当前范围内的音符位置总数
    function calculatePositionCount() {
      const minIndex = randomRangeProps.minIndex;
      const maxIndex = randomRangeProps.maxIndex;
      
      // 确保minIndex <= maxIndex
      const actualMin = Math.min(minIndex, maxIndex);
      const actualMax = Math.max(minIndex, maxIndex);
      
      // 位置总数 = 最大索引 - 最小索引 + 1
      return actualMax - actualMin + 1;
    }
    
    // 更新不重复随机数量的最大值
    function updateNonRepeatMaxCount() {
      const positionCount = calculatePositionCount();
      
      // 最大可设置数量 = 位置总数 - 1
      nonRepeatProps.maxCount = Math.max(0, positionCount - 1);
      
      // 如果当前设置值超过了新的最大值，则调整为最大值
      if (nonRepeatProps.count > nonRepeatProps.maxCount) {
        nonRepeatProps.count = nonRepeatProps.maxCount;
        
        // 更新UI
        nonRepeatSlider.value = nonRepeatProps.count;
        nonRepeatInput.value = nonRepeatProps.count;
      }
      
      updateNonRepeatValueDisplay();
    }
    
    // 更新不重复随机数量显示
    function updateNonRepeatValueDisplay() {
      nonRepeatValue.textContent = `${nonRepeatSlider.value}`;
      nonRepeatInput.value = nonRepeatSlider.value;
      
      // 设置输入框的最大值限制
      nonRepeatInput.max = nonRepeatProps.maxCount;
      nonRepeatSlider.max = nonRepeatProps.maxCount;
    }
    
    // 绘制五线谱、高音谱号、全音符和加线
    function drawLines() {
      if (!ctx) return;
      
      // 清除画布
      const displayWidth = canvas.clientWidth;
      const displayHeight = canvas.clientHeight;
      ctx.clearRect(0, 0, displayWidth, displayHeight);
      
      // 获取当前线条参数值
      const spacing = parseInt(spacingSlider.value);
      const basePosition = parseInt(positionSlider.value);
      const thickness = parseInt(thicknessSlider.value);
      const lengthPercent = parseInt(lengthSlider.value) / 100;
      const lineColor = colorPicker.value;
      
      // 计算线条尺寸和位置
      const lineLength = displayWidth * lengthPercent;
      const startX = (displayWidth - lineLength) / 2;
      
      // 存储所有线条的坐标（第一线在最下面，第五线在最上面）
      const lines = [];
      for (let i = 0; i < 5; i++) {
        // 第一线在最下面（i=0），第五线在最上面（i=4）
        const y = basePosition - i * spacing;
        if (y > 0 && y < displayHeight) {
          lines.push({ x1: startX, y1: y, x2: startX + lineLength, y2: y });
        }
      }
      
      // 设置线条样式
      ctx.strokeStyle = lineColor;
      ctx.lineWidth = thickness;
      ctx.lineCap = 'round';
      
      // 绘制所有线条
      lines.forEach(line => {
        ctx.beginPath();
        ctx.moveTo(line.x1, line.y1);
        ctx.lineTo(line.x2, line.y2);
        ctx.stroke();
      });
      
      // 绘制高音谱号（如果已加载且设置为显示）
      if (clefProps.show && clefImage.complete) {
        let drawWidth, drawHeight, drawX, drawY;
        
        if (clefProps.autoSnap) {
          // 自动计算谱号位置和大小
          const calculated = calculateClefPosition();
          drawX = calculated.x;
          drawY = calculated.y;
          drawWidth = calculated.width;
          drawHeight = calculated.height;
        } else {
          // 使用手动设置的谱号位置和大小
          const scale = clefProps.size / 100;
          drawWidth = clefProps.width * scale;
          drawHeight = clefProps.height * scale;
          drawX = clefProps.x;
          drawY = clefProps.y;
        }
        
        // 绘制图片（保持透明度）
        ctx.drawImage(
          clefImage, 
          drawX, 
          drawY, 
          drawWidth, 
          drawHeight
        );
      }
      
      // 绘制全音符（如果已加载且设置为显示）
      if (noteProps.show && noteImage.complete) {
        const scale = noteProps.size / 100;
        const drawWidth = noteProps.width * scale;
        const drawHeight = noteProps.height * scale;
        
        // 绘制图片（保持透明度）
        ctx.drawImage(
          noteImage, 
          noteProps.x, 
          noteProps.y, 
          drawWidth, 
          drawHeight
        );
        
        // 计算音符中心位置
        const noteCenterX = noteProps.x + drawWidth / 2;
        const noteCenterY = noteProps.y + drawHeight / 2;
        
        // 绘制加线
        drawLedgerLines(noteCenterX, noteCenterY, drawWidth);
        
        // 更新位置显示 - 合并为一行，左侧显示音名，右侧显示位置
        const positionInfo = getLineOrSpaceName(noteCenterY);
        // 音名前添加"音名："前缀
        pitchText.textContent = `音名：${positionInfo.pitchName}`;
        positionText.textContent = positionInfo.lineSpaceName;
        
        // 设置位置显示文本的样式
        updatePositionDisplayStyle();
        
        // 只有在非拖拽状态下才显示吸附指示器
        if (snapProps.isSnapping && snapProps.enabled && !noteProps.isDragging) {
          snapIndicator.style.left = `${noteCenterX - 8}px`;
          snapIndicator.style.top = `${snapProps.snapPosition - 8}px`;
          snapIndicator.style.opacity = '1';
        } else {
          snapIndicator.style.opacity = '0';
        }
      } else {
        snapIndicator.style.opacity = '0';
      }
    }
    
    // 绘制钢琴键盘
    function drawPiano() {
      // 清空钢琴键盘
      pianoKeys.innerHTML = '';
      pianoProps.keys = [];
      
      // 计算钢琴键盘尺寸
      const pianoWidth = pianoProps.keyWidth * 52 * pianoProps.scale; // 52个白键，考虑缩放
      pianoKeys.style.width = `${pianoWidth}px`;
      
      // 创建白键和黑键
      let whiteKeyIndex = 0;
      
      // 计算要显示的键的范围（基于组数）
      const totalGroups = 7; // 标准钢琴有7组
      const groupsToShow = pianoProps.groups;
      const startGroup = Math.floor((totalGroups - groupsToShow) / 2);
      const startIndex = startGroup * 12; // 每组12个键
      const endIndex = startIndex + groupsToShow * 12;
      
      // 创建白键和黑键
      for (let i = 0; i < standardPianoKeyNames.length; i++) {
        const keyName = standardPianoKeyNames[i];
        const isBlack = keyName.includes('#');
        
        // 检查是否在显示范围内
        if (i < startIndex || i >= endIndex) continue;
        
        if (isBlack) {
          // 创建黑键
          const blackKey = document.createElement('div');
          blackKey.className = 'black-key';
          
          // 计算黑键位置 - 中心对准两个白键的缝隙
          const position = (whiteKeyIndex - 0.5) * pianoProps.keyWidth * pianoProps.scale + 
                          pianoProps.keyWidth * pianoProps.scale / 2 - 
                          (pianoProps.keyWidth * pianoProps.scale * 0.6) / 2;
          blackKey.style.left = `${position}px`;
          blackKey.style.width = `${pianoProps.keyWidth * pianoProps.scale * 0.6}px`;
          
          // 添加音名标签
          const keyLabel = document.createElement('div');
          keyLabel.className = 'key-label';
          
          // 根据设置决定显示什么标签
          if (pianoProps.showAllNames) {
            keyLabel.textContent = keyName;
          } else if (pianoProps.showOnlyCentralC && keyName === 'C4') {
            keyLabel.textContent = keyName;
            keyLabel.classList.add('central-c-label');
          }
          
          blackKey.appendChild(keyLabel);
          
          // 存储键的信息
          pianoProps.keys.push({
            element: blackKey,
            name: keyName,
            isBlack: true
          });
          
          pianoKeys.appendChild(blackKey);
        } else {
          // 创建白键
          const whiteKey = document.createElement('div');
          whiteKey.className = 'white-key';
          whiteKey.style.left = `${whiteKeyIndex * pianoProps.keyWidth * pianoProps.scale}px`;
          whiteKey.style.width = `${pianoProps.keyWidth * pianoProps.scale}px`;
          
          // 添加音名标签
          const keyLabel = document.createElement('div');
          keyLabel.className = 'key-label';
          
          // 根据设置决定显示什么标签
          if (pianoProps.showAllNames) {
            keyLabel.textContent = keyName;
          } else if (pianoProps.showOnlyCentralC && keyName === 'C4') {
            keyLabel.textContent = keyName;
            keyLabel.classList.add('central-c-label');
          }
          
          whiteKey.appendChild(keyLabel);
          
          // 存储键的信息
          pianoProps.keys.push({
            element: whiteKey,
            name: keyName,
            isBlack: false
          });
          
          pianoKeys.appendChild(whiteKey);
          whiteKeyIndex++;
        }
      }
      
      // 添加事件监听
      addPianoEventListeners();
    }
    
    // 添加钢琴键盘事件监听
    function addPianoEventListeners() {
      pianoProps.keys.forEach(key => {
        // 移除原来的 mousedown 和 touchstart 事件
        // 添加 mouseup 和 touchend 事件
        key.element.addEventListener('mouseup', (e) => {
          handlePianoKeyPress(key, e);
        });
        
        key.element.addEventListener('touchend', (e) => {
          handlePianoKeyPress(key, e);
        });

        // 添加鼠标按下和触摸开始事件来提供视觉反馈
        key.element.addEventListener('mousedown', (e) => {
          e.preventDefault();
          key.element.classList.add('active');
        });
        
        key.element.addEventListener('touchstart', (e) => {
          e.preventDefault();
          key.element.classList.add('active');
        });
      });
    }

    // 处理钢琴键松开
    function handlePianoKeyPress(key, e) {
      // 阻止默认行为
      e.preventDefault();
      
      // 移除活动状态
      key.element.classList.remove('active');
      
      // 获取当前音符的音名
      const currentNoteName = pitchText.textContent.replace('音名：', '');
      
      // 检查按键是否正确
      if (key.name === currentNoteName) {
        // 正确
        showFeedback('正确！', true);
        setTimeout(() => {
          randomMoveNote();
        }, 500);
      } else {
        // 错误
        showFeedback('错了！', false);
      }
    }
    
    // 显示反馈信息
    function showFeedback(message, isCorrect) {
      feedbackDisplay.textContent = message;
      feedbackDisplay.style.display = 'block';
      feedbackDisplay.style.backgroundColor = isCorrect ? 'rgba(76, 175, 80, 0.9)' : 'rgba(244, 67, 54, 0.9)';
      
      setTimeout(() => {
        feedbackDisplay.style.display = 'none';
      }, 500);
    }
    
    // 随机移动音符到指定范围内的位置
    function randomMoveNote() {
      if (!noteProps.show || !noteImage.complete) return;
      
      const basePosition = parseInt(positionSlider.value);
      const spacing = parseInt(spacingSlider.value);
      
      // 获取随机范围
      const minIndex = randomRangeProps.minIndex;
      const maxIndex = randomRangeProps.maxIndex;
      
      // 确保minIndex <= maxIndex
      const actualMin = Math.min(minIndex, maxIndex);
      const actualMax = Math.max(minIndex, maxIndex);
      
      let randomIndex;
      
      // 如果不重复随机功能启用
      if (nonRepeatProps.count > 0) {
        // 如果历史记录数量达到限制，清空历史记录
        if (nonRepeatProps.history.length >= nonRepeatProps.count) {
          nonRepeatProps.history = [];
        }
        
        // 生成可用位置列表
        const availablePositions = [];
        for (let i = actualMin; i <= actualMax; i++) {
          if (!nonRepeatProps.history.includes(i)) {
            availablePositions.push(i);
          }
        }
        
        // 如果没有可用位置，清空历史记录重新开始
        if (availablePositions.length === 0) {
          nonRepeatProps.history = [];
          for (let i = actualMin; i <= actualMax; i++) {
            availablePositions.push(i);
          }
        }
        
        // 从可用位置中随机选择一个
        randomIndex = availablePositions[Math.floor(Math.random() * availablePositions.length)];
        
        // 添加到历史记录
        nonRepeatProps.history.push(randomIndex);
        
        // 更新历史记录显示
        updateNonRepeatHistoryDisplay();
      } else {
        // 普通随机模式（允许重复）
        randomIndex = Math.floor(Math.random() * (actualMax - actualMin + 1)) + actualMin;
      }
      
      // 计算对应的Y坐标
      const yPosition = basePosition - randomIndex * (spacing / 2);
      
      // 计算音符高度
      const noteHeight = noteProps.height * (noteProps.size / 100);
      
      // 设置音符位置（保持X坐标不变，只改变Y坐标）
      noteProps.y = yPosition - noteHeight / 2;
      
      // 更新滑块值
      noteYSlider.value = Math.round(noteProps.y);
      updateNoteValueDisplay();
      
      // 重绘
      drawLines();
    }
    
    // 根据音名移动音符到对应的五线谱位置
    function moveNoteToPitch(pitchName) {
      if (!noteProps.show || !noteImage.complete) return;
      
      const basePosition = parseInt(positionSlider.value);
      const spacing = parseInt(spacingSlider.value);
      
      // 获取音名对应的五线谱位置索引
      const staffIndex = pitchToStaffPosition[pitchName];
      if (staffIndex === undefined) return;
      
      // 计算对应的Y坐标
      const yPosition = basePosition - staffIndex * (spacing / 2);
      
      // 计算音符高度
      const noteHeight = noteProps.height * (noteProps.size / 100);
      
      // 设置音符位置（保持X坐标不变，只改变Y坐标）
      noteProps.y = yPosition - noteHeight / 2;
      
      // 更新滑块值
      noteYSlider.value = Math.round(noteProps.y);
      updateNoteValueDisplay();
      
      // 重绘
      drawLines();
    }
    
    // 高亮对应的钢琴键
    function highlightPianoKey(pitchName, isActive) {
      // 找到对应的钢琴键
      const key = pianoProps.keys.find(k => k.name === pitchName);
      if (key) {
        if (isActive) {
          key.element.classList.add('midi-active');
        } else {
          key.element.classList.remove('midi-active');
        }
      }
    }
    
    // 处理MIDI输入
    function handleMidiMessage(event) {
      const [command, note, velocity] = event.data;
      
      // 只处理音符开和音符关事件
      if ((command & 0xf0) === 0x90 && velocity > 0) { // 音符开
        const pitchName = midiNoteToPitch[note];
        if (pitchName) {
          // 更新MIDI音符显示
          midiNoteDisplay.textContent = `${pitchName} (${note})`;
          midiProps.lastNote = pitchName;
          
          // 添加音符到活动集合
          midiProps.activeNotes.add(note);
          
          // 高亮对应的钢琴键
          highlightPianoKey(pitchName, true);
          
          // 如果启用了音符对比，检查是否正确
          if (midiProps.noteCompare) {
            const currentNoteName = pitchText.textContent.replace('音名：', '');
            
            if (pitchName === currentNoteName) {
              // 正确
              showFeedback('正确！', true);
              setTimeout(() => {
                randomMoveNote();
              }, 500);
            } else {
              // 错误
              showFeedback('错了！', false);
            }
          }
        }
      } else if ((command & 0xf0) === 0x80 || ((command & 0xf0) === 0x90 && velocity === 0)) { // 音符关
        // 从活动集合中移除音符
        midiProps.activeNotes.delete(note);
        
        const pitchName = midiNoteToPitch[note];
        if (pitchName) {
          // 取消高亮对应的钢琴键
          highlightPianoKey(pitchName, false);
        }
      }
    }
    
    // 请求MIDI访问权限
    async function requestMidiAccess() {
      try {
        if (!navigator.requestMIDIAccess) {
          console.error('您的浏览器不支持Web MIDI API');
          alert('您的浏览器不支持Web MIDI API，无法使用MIDI设备功能');
          return false;
        }
        
        midiProps.access = await navigator.requestMIDIAccess();
        console.log('MIDI访问权限已获取');
        
        // 监听MIDI设备连接和断开
        midiProps.access.onstatechange = (event) => {
          console.log('MIDI设备状态变化:', event.port.name, event.port.state);
          refreshMidiDevices();
        };
        
        // 初始刷新设备列表
        refreshMidiDevices();
        return true;
      } catch (error) {
        console.error('获取MIDI访问权限失败:', error);
        alert('获取MIDI访问权限失败，请确保您的浏览器支持Web MIDI API');
        return false;
      }
    }
    
    // 刷新MIDI设备列表
    function refreshMidiDevices() {
      if (!midiProps.access) return;
      
      // 清空设备列表
      midiDeviceSelect.innerHTML = '<option value="">-- 请选择MIDI设备 --</option>';
      midiProps.inputs = [];
      
      // 获取所有MIDI输入设备
      const inputs = midiProps.access.inputs.values();
      for (const input of inputs) {
        midiProps.inputs.push(input);
        const option = document.createElement('option');
        option.value = input.id;
        option.textContent = input.name;
        if (input === midiProps.selectedInput) {
          option.selected = true;
        }
        midiDeviceSelect.appendChild(option);
      }
      
      // 更新设备状态
      if (midiProps.selectedInput && midiProps.selectedInput.state === 'connected') {
        midiDeviceStatus.textContent = '已连接';
        midiDeviceStatus.className = 'text-sm font-mono midi-connected';
      } else {
        midiDeviceStatus.textContent = '未连接';
        midiDeviceStatus.className = 'text-sm font-mono midi-disconnected';
        midiProps.selectedInput = null;
      }
      
      updateMidiStatus();
    }
    
    // 选择MIDI设备
    function selectMidiDevice(deviceId) {
      if (!midiProps.access) return;
      
      // 取消之前选中的设备监听
      if (midiProps.selectedInput) {
        midiProps.selectedInput.onmidimessage = null;
      }
      
      // 选择新设备
      midiProps.selectedInput = midiProps.inputs.find(input => input.id === deviceId) || null;
      
      if (midiProps.selectedInput) {
        // 设置新设备的监听
        midiProps.selectedInput.onmidimessage = handleMidiMessage;
        console.log(`已选择MIDI设备: ${midiProps.selectedInput.name}`);
        
        // 更新设备状态
        midiDeviceStatus.textContent = '已连接';
        midiDeviceStatus.className = 'text-sm font-mono midi-connected';
      } else {
        // 更新设备状态
        midiDeviceStatus.textContent = '未连接';
        midiDeviceStatus.className = 'text-sm font-mono midi-disconnected';
      }
      
      updateMidiStatus();
    }
    
    // 启用/禁用MIDI输入
    function toggleMidiInput(enabled) {
      midiProps.enabled = enabled;
      
      if (enabled) {
        // 启用MIDI输入
        requestMidiAccess().then(success => {
          if (!success) {
            enableMidiInputCheckbox.checked = false;
            midiProps.enabled = false;
          }
        });
      } else {
        // 禁用MIDI输入
        if (midiProps.selectedInput) {
          midiProps.selectedInput.onmidimessage = null;
          midiProps.selectedInput = null;
        }
        midiProps.access = null;
        
        // 清除所有MIDI键高亮
        midiProps.activeNotes.clear();
        pianoProps.keys.forEach(key => {
          key.element.classList.remove('midi-active');
        });
      }
      
      updateMidiStatus();
    }
    
    // 更新显示的参数值
    function updateLinesValueDisplay() {
      spacingValue.textContent = `${spacingSlider.value}px`;
      spacingInput.value = spacingSlider.value;
      positionValue.textContent = `${positionSlider.value}px`;
      positionInput.value = positionSlider.value;
      thicknessValue.textContent = `${thicknessSlider.value}px`;
      thicknessInput.value = thicknessSlider.value;
      lengthValue.textContent = `${lengthSlider.value}%`;
      lengthInput.value = lengthSlider.value;
      snapStrengthValue.textContent = `${snapStrengthSlider.value}%`;
      snapStrengthInput.value = snapStrengthSlider.value;
    }
    
    function updateClefValueDisplay() {
      clefSizeValue.textContent = `${clefSizeSlider.value}%`;
      clefSizeInput.value = clefSizeSlider.value;
    }
    
    function updateNoteValueDisplay() {
      noteXValue.textContent = `${noteXSlider.value}px`;
      noteXInput.value = noteXSlider.value;
      noteYValue.textContent = `${noteYSlider.value}px`;
      noteYInput.value = noteYSlider.value;
      noteSizeValue.textContent = `${noteSizeSlider.value}%`;
      noteSizeInput.value = noteSizeSlider.value;
    }
    
    function updateTextValueDisplay() {
      textSizeValue.textContent = `${textSizeSlider.value}px`;
      textSizeInput.value = textSizeSlider.value;
    }
    
    function updatePianoValueDisplay() {
      pianoHeightValue.textContent = `${pianoHeightSlider.value}px`;
      pianoHeightInput.value = pianoHeightSlider.value;
      pianoPositionValue.textContent = `${pianoPositionSlider.value}px`;
      pianoPositionInput.value = pianoPositionSlider.value;
      pianoHorizontalValue.textContent = `${pianoHorizontalSlider.value}px`;
      pianoHorizontalInput.value = pianoHorizontalSlider.value;
      pianoKeyWidthValue.textContent = `${pianoKeyWidthSlider.value}px`;
      pianoKeyWidthInput.value = pianoKeyWidthSlider.value;
      pianoGroupsValue.textContent = `${pianoGroupsSlider.value}组`;
      pianoGroupsInput.value = pianoGroupsSlider.value;
    }
    
    // 获取触摸或鼠标事件的坐标
    function getEventPosition(e) {
      const rect = canvas.getBoundingClientRect();
      let clientX, clientY;
      
      if (e.type.includes('touch')) {
        // 触摸事件
        const touch = e.touches[0] || e.changedTouches[0];
        clientX = touch.clientX;
        clientY = touch.clientY;
      } else {
        // 鼠标事件
        clientX = e.clientX;
        clientY = e.clientY;
      }
      
      return {
        x: clientX - rect.left,
        y: clientY - rect.top
      };
    }
    
    // 查找最近的吸附位置（包括上下加线和加间）
    function findNearestSnapPosition(noteCenterY) {
      const basePosition = parseInt(positionSlider.value);
      const spacing = parseInt(spacingSlider.value);
      
      // 生成所有可能的吸附位置（从下加八线到上加八线，共41个位置）
      const snapPositions = [];
      
      // 从下加八线（索引-16）到上加八线（索引24）
      for (let i = -16; i <= 24; i++) {
        snapPositions.push(basePosition - i * (spacing / 2));
      }
      
      // 寻找最近的吸附位置
      let closestPos = noteCenterY;
      let minDist = Infinity;
      snapPositions.forEach(pos => {
        const dist = Math.abs(noteCenterY - pos);
        if (dist < minDist) {
          minDist = dist;
          closestPos = pos;
        }
      });
      
      return { position: closestPos, distance: minDist };
    }
    
    // 计算两点之间的距离
    function getDistance(touch1, touch2) {
      const dx = touch1.clientX - touch2.clientX;
      const dy = touch1.clientY - touch2.clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }
    
    // 处理拖拽功能（含全音符吸附逻辑）
    function handleDrag(e) {
      // 阻止默认行为，特别是触摸事件的页面滚动
      e.preventDefault();
      
      // 获取事件位置
      const pos = getEventPosition(e);
      const mouseX = pos.x;
      const mouseY = pos.y;
      
      // 更新鼠标位置显示
      updateMousePosition(mouseX, mouseY);
      
      // 鼠标/触摸按下时
      if (e.type === 'mousedown' || e.type === 'touchstart') {
        // 检查是否点击在钢琴拖拽区域上
        if (pianoProps.show) {
          const pianoDragRect = pianoDragHandle.getBoundingClientRect();
          const canvasRect = canvas.getBoundingClientRect();
          const dragX = mouseX;
          const dragY = mouseY + canvasRect.top - pianoDragRect.top;
          
          if (dragX >= 0 && dragX <= pianoDragRect.width &&
              dragY >= 0 && dragY <= pianoDragRect.height) {
            pianoProps.isDragging = true;
            noteProps.isDragging = false;
            clefProps.isDragging = false;
            pianoProps.offsetX = mouseX;
            pianoProps.offsetY = mouseY;
            canvas.style.cursor = 'grabbing';
            return;
          }
        }
        
        // 再检查是否点击在全音符上
        if (noteProps.show && noteImage.complete) {
          const scale = noteProps.size / 100;
          const drawWidth = noteProps.width * scale;
          const drawHeight = noteProps.height * scale;
          
          if (mouseX >= noteProps.x && mouseX <= noteProps.x + drawWidth &&
              mouseY >= noteProps.y && mouseY <= noteProps.y + drawHeight) {
            noteProps.isDragging = true;
            clefProps.isDragging = false;
            pianoProps.isDragging = false;
            noteProps.offsetX = mouseX - noteProps.x;
            noteProps.offsetY = mouseY - noteProps.y;
            canvas.style.cursor = 'grabbing';
            
            // 拖拽开始时隐藏吸附指示器
            snapIndicator.style.opacity = '0';
            return;
          }
        }
        
        // 再检查是否点击在谱号上
        if (!clefProps.autoSnap && clefProps.show && clefImage.complete) {
          const scale = clefProps.size / 100;
          const drawWidth = clefProps.width * scale;
          const drawHeight = clefProps.height * scale;
          
          if (mouseX >= clefProps.x && mouseX <= clefProps.x + drawWidth &&
              mouseY >= clefProps.y && mouseY <= clefProps.y + drawHeight) {
            clefProps.isDragging = true;
            noteProps.isDragging = false;
            pianoProps.isDragging = false;
            clefProps.offsetX = mouseX - clefProps.x;
            clefProps.offsetY = mouseY - clefProps.y;
            canvas.style.cursor = 'grabbing';
            return;
          }
        }
        
        // 如果都没点中，不启用拖拽
        clefProps.isDragging = false;
        noteProps.isDragging = false;
        pianoProps.isDragging = false;
        canvas.style.cursor = 'default';
      }
      // 鼠标/触摸移动时
      else if (e.type === 'mousemove' || e.type === 'touchmove') {
        // 处理双指缩放
        if (e.touches && e.touches.length === 2 && pianoProps.enablePinchZoom) {
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          const currentDistance = getDistance(touch1, touch2);
          
          if (pianoProps.initialDistance === null) {
            pianoProps.initialDistance = currentDistance;
          } else {
            const scaleChange = currentDistance / pianoProps.initialDistance;
            pianoProps.scale = Math.max(0.5, Math.min(2, pianoProps.scale * scaleChange));
            pianoProps.initialDistance = currentDistance;
            
            // 更新钢琴键盘
            drawPiano();
          }
          return;
        }
        
        // 拖拽全音符（含吸附逻辑）
        if (noteProps.isDragging) {
          noteProps.x = mouseX - noteProps.offsetX;
          noteProps.y = mouseY - noteProps.offsetY;
          
          // 应用吸附逻辑
          if (snapProps.enabled) {
            const noteHeight = noteProps.height * (noteProps.size / 100);
            const noteCenterY = noteProps.y + noteHeight / 2;
            
            // 查找最近的吸附位置（包括上下加线和加间）
            const snapResult = findNearestSnapPosition(noteCenterY);
            
            // 定义吸附阈值（线间距的百分比）
            const snapThreshold = (parseInt(spacingSlider.value) * snapProps.strength) / 100;
            
            if (snapResult.distance < snapThreshold) {
              // 调整y坐标，使全音符中心对齐到最近的线/间
              noteProps.y = snapResult.position - (noteHeight / 2);
              snapProps.isSnapping = true;
              snapProps.snapPosition = snapResult.position;
            } else {
              snapProps.isSnapping = false;
            }
          } else {
            snapProps.isSnapping = false;
          }
          
          // 更新滑块值以保持同步
          noteXSlider.value = Math.round(noteProps.x);
          noteYSlider.value = Math.round(noteProps.y);
          updateNoteValueDisplay();
          
          drawLines();
        }
        // 拖拽谱号（仅在禁用自动吸附时）
        else if (clefProps.isDragging && !clefProps.autoSnap) {
          clefProps.x = mouseX - clefProps.offsetX;
          clefProps.y = mouseY - clefProps.offsetY;
          drawLines();
        }
        // 拖拽钢琴键盘
        else if (pianoProps.isDragging) {
          const deltaX = mouseX - pianoProps.offsetX;
          pianoProps.horizontal += deltaX;
          pianoProps.horizontal = Math.max(-500, Math.min(500, pianoProps.horizontal));
          pianoProps.offsetX = mouseX;
          
          pianoHorizontalSlider.value = Math.round(pianoProps.horizontal);
          updatePianoValueDisplay();
          updatePianoPosition();
        }
        // 鼠标悬停时改变光标（仅鼠标事件）
        else if (e.type === 'mousemove') {
          let isOverElement = false;
          
          // 检查是否悬停在钢琴拖拽区域上
          if (pianoProps.show) {
            const pianoDragRect = pianoDragHandle.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            const dragX = mouseX;
            const dragY = mouseY + canvasRect.top - pianoDragRect.top;
            
            if (dragX >= 0 && dragX <= pianoDragRect.width &&
                dragY >= 0 && dragY <= pianoDragRect.height) {
              canvas.style.cursor = 'grab';
              isOverElement = true;
            }
          }
          
          // 检查是否悬停在全音符上
          if (!isOverElement && noteProps.show && noteImage.complete) {
            const scale = noteProps.size / 100;
            const drawWidth = noteProps.width * scale;
            const drawHeight = noteProps.height * scale;
            
            if (mouseX >= noteProps.x && mouseX <= noteProps.x + drawWidth &&
                mouseY >= noteProps.y && mouseY <= noteProps.y + drawHeight) {
              canvas.style.cursor = 'grab';
              isOverElement = true;
            }
          }
          
          // 检查是否悬停在谱号上（仅在禁用自动吸附时）
          if (!isOverElement && !clefProps.autoSnap && clefProps.show && clefImage.complete) {
            const scale = clefProps.size / 100;
            const drawWidth = clefProps.width * scale;
            const drawHeight = clefProps.height * scale;
            
            if (mouseX >= clefProps.x && mouseX <= clefProps.x + drawWidth &&
                mouseY >= clefProps.y && mouseY <= clefProps.y + drawHeight) {
              canvas.style.cursor = 'grab';
              isOverElement = true;
            }
          }
          
          // 不在任何元素上时恢复默认光标
          if (!isOverElement) {
            canvas.style.cursor = 'default';
          }
        }
      }
      // 鼠标/触摸释放时
      else if (e.type === 'mouseup' || e.type === 'mouseleave' || e.type === 'touchend') {
        // 重置双指缩放
        pianoProps.initialDistance = null;
        
        clefProps.isDragging = false;
        noteProps.isDragging = false;
        pianoProps.isDragging = false;
        snapProps.isSnapping = false;
        canvas.style.cursor = 'default';
        drawLines(); // 重绘以隐藏吸附指示器
      }
    }
    
    // 更新钢琴键盘位置
    function updatePianoPosition() {
      pianoContainer.style.bottom = `${pianoProps.position}px`;
      pianoKeys.style.transform = `translateX(${pianoProps.horizontal}px) scale(${pianoProps.scale})`;
    }
    
    // 更新钢琴键盘高度
    function updatePianoHeight() {
      pianoContainer.style.height = `${pianoProps.height}px`;
    }
    
    // 更新钢琴键盘宽度
    function updatePianoKeyWidth() {
      drawPiano();
      updatePianoPosition();
    }
    
    // 更新钢琴键盘组数
    function updatePianoGroups() {
      drawPiano();
      updatePianoPosition();
    }
    
    // 更新钢琴键盘音名显示
    function updatePianoKeyLabels() {
      drawPiano();
    }
    
    // 更新钢琴键盘缩放
    function updatePianoScale() {
      drawPiano();
      updatePianoPosition();
    }
    
    // 绑定鼠标事件
    canvas.addEventListener('mousedown', handleDrag);
    canvas.addEventListener('mousemove', handleDrag);
    canvas.addEventListener('mouseup', handleDrag);
    canvas.addEventListener('mouseleave', handleDrag);
    
    // 绑定触摸事件（移动端支持）
    canvas.addEventListener('touchstart', handleDrag, { passive: false });
    canvas.addEventListener('touchmove', handleDrag, { passive: false });
    canvas.addEventListener('touchend', handleDrag, { passive: false });
    canvas.addEventListener('touchcancel', handleDrag, { passive: false });
    
    // 设置滑块和输入框事件同步函数
    function setupSliderInputSync(slider, input, min, max, updateFunction) {
      slider.addEventListener('input', () => {
        input.value = slider.value;
        updateFunction();
        drawLines();
      });
      
      input.addEventListener('input', () => {
        let value = parseInt(input.value);
        if (isNaN(value)) value = min;
        if (value < min) value = min;
        if (value > max) value = max;
        input.value = value;
        slider.value = value;
        updateFunction();
        drawLines();
      });
      
      input.addEventListener('change', () => {
        let value = parseInt(input.value);
        if (isNaN(value)) value = min;
        if (value < min) value = min;
        if (value > max) value = max;
        input.value = value;
        slider.value = value;
        updateFunction();
        drawLines();
      });
    }
    
    // 设置线条设置的滑块和输入框同步
    setupSliderInputSync(spacingSlider, spacingInput, 10, 100, updateLinesValueDisplay);
    setupSliderInputSync(positionSlider, positionInput, 50, 800, updateLinesValueDisplay);
    setupSliderInputSync(thicknessSlider, thicknessInput, 1, 10, updateLinesValueDisplay);
    setupSliderInputSync(lengthSlider, lengthInput, 30, 100, updateLinesValueDisplay);
    setupSliderInputSync(snapStrengthSlider, snapStrengthInput, 10, 50, updateLinesValueDisplay);
    
    // 设置谱号设置的滑块和输入框同步
    setupSliderInputSync(clefSizeSlider, clefSizeInput, 50, 200, updateClefValueDisplay);
    
    // 设置全音符设置的滑块和输入框同步
    setupSliderInputSync(noteXSlider, noteXInput, 50, 800, updateNoteValueDisplay);
    setupSliderInputSync(noteYSlider, noteYInput, 50, 500, updateNoteValueDisplay);
    setupSliderInputSync(noteSizeSlider, noteSizeInput, 5, 200, updateNoteValueDisplay);
    
    // 设置文本设置的滑块和输入框同步
    setupSliderInputSync(textSizeSlider, textSizeInput, 8, 30, updateTextValueDisplay);
    
    // 设置钢琴键盘设置的滑块和输入框同步
    setupSliderInputSync(pianoHeightSlider, pianoHeightInput, 80, 300, updatePianoValueDisplay);
    setupSliderInputSync(pianoPositionSlider, pianoPositionInput, 0, 500, updatePianoValueDisplay);
    setupSliderInputSync(pianoHorizontalSlider, pianoHorizontalInput, -500, 500, updatePianoValueDisplay);
    setupSliderInputSync(pianoKeyWidthSlider, pianoKeyWidthInput, 20, 80, updatePianoValueDisplay);
    setupSliderInputSync(pianoGroupsSlider, pianoGroupsInput, 1, 7, updatePianoValueDisplay);
    
    // 设置不重复随机数量滑块和输入框同步
    setupSliderInputSync(nonRepeatSlider, nonRepeatInput, 0, 10, updateNonRepeatValueDisplay);
    
    // 其他事件监听
    colorPicker.addEventListener('input', drawLines);
    
    snapEnabledCheckbox.addEventListener('change', () => {
      snapProps.enabled = snapEnabledCheckbox.checked;
      drawLines();
    });
    
    snapStrengthSlider.addEventListener('input', () => {
      snapProps.strength = parseInt(snapStrengthSlider.value);
      updateLinesValueDisplay();
      drawLines();
    });
    
    showClefCheckbox.addEventListener('change', () => {
      clefProps.show = showClefCheckbox.checked;
      drawLines();
    });
    
    clefAutoSnapCheckbox.addEventListener('change', () => {
      clefProps.autoSnap = clefAutoSnapCheckbox.checked;
      drawLines();
    });
    
    clefSizeSlider.addEventListener('input', () => {
      clefProps.size = parseInt(clefSizeSlider.value);
      updateClefValueDisplay();
      drawLines();
    });
    
    showNoteCheckbox.addEventListener('change', () => {
      noteProps.show = showNoteCheckbox.checked;
      drawLines();
    });
    
    textColorPicker.addEventListener('input', () => {
      textProps.color = textColorPicker.value;
      updatePositionDisplayStyle();
      updateNonRepeatHistoryDisplay();
    });
    
    textSizeSlider.addEventListener('input', () => {
      textProps.size = parseInt(textSizeSlider.value);
      updateTextValueDisplay();
      updatePositionDisplayStyle();
      updateNonRepeatHistoryDisplay();
    });
    
    textFontSelect.addEventListener('change', () => {
      textProps.font = textFontSelect.value;
      updatePositionDisplayStyle();
      updateNonRepeatHistoryDisplay();
    });
    
    showPositionDisplayCheckbox.addEventListener('change', () => {
      textProps.showPositionDisplay = showPositionDisplayCheckbox.checked;
      updatePositionDisplayStyle();
    });
    
    showRandomButtonCheckbox.addEventListener('change', () => {
      textProps.showRandomButton = showRandomButtonCheckbox.checked;
      updateRandomButtonDisplay();
    });
    
    showNonRepeatHistoryCheckbox.addEventListener('change', () => {
      textProps.showNonRepeatHistory = showNonRepeatHistoryCheckbox.checked;
      updateNonRepeatHistoryDisplay();
    });
    
    showPianoCheckbox.addEventListener('change', () => {
      pianoProps.show = showPianoCheckbox.checked;
      pianoContainer.style.display = pianoProps.show ? 'block' : 'none';
    });
    
    pianoHeightSlider.addEventListener('input', () => {
      pianoProps.height = parseInt(pianoHeightSlider.value);
      updatePianoHeight();
      drawPiano();
    });
    
    pianoPositionSlider.addEventListener('input', () => {
      pianoProps.position = parseInt(pianoPositionSlider.value);
      updatePianoPosition();
    });
    
    pianoHorizontalSlider.addEventListener('input', () => {
      pianoProps.horizontal = parseInt(pianoHorizontalSlider.value);
      updatePianoPosition();
    });
    
    pianoKeyWidthSlider.addEventListener('input', () => {
      pianoProps.keyWidth = parseInt(pianoKeyWidthSlider.value);
      updatePianoKeyWidth();
    });
    
    pianoGroupsSlider.addEventListener('input', () => {
      pianoProps.groups = parseInt(pianoGroupsSlider.value);
      updatePianoGroups();
    });
    
    showAllNamesCheckbox.addEventListener('change', () => {
      pianoProps.showAllNames = showAllNamesCheckbox.checked;
      if (pianoProps.showAllNames) {
        showOnlyCentralCCheckbox.checked = false;
        pianoProps.showOnlyCentralC = false;
      }
      updatePianoKeyLabels();
    });
    
    showOnlyCentralCCheckbox.addEventListener('change', () => {
      pianoProps.showOnlyCentralC = showOnlyCentralCCheckbox.checked;
      if (pianoProps.showOnlyCentralC) {
        showAllNamesCheckbox.checked = false;
        pianoProps.showAllNames = false;
      }
      updatePianoKeyLabels();
    });
    
    enablePinchZoomCheckbox.addEventListener('change', () => {
      pianoProps.enablePinchZoom = enablePinchZoomCheckbox.checked;
    });
    
    // MIDI设置事件监听
    enableMidiInputCheckbox.addEventListener('change', () => {
      toggleMidiInput(enableMidiInputCheckbox.checked);
    });
    
    midiNoteCompareCheckbox.addEventListener('change', () => {
      midiProps.noteCompare = midiNoteCompareCheckbox.checked;
    });
    
    midiDeviceSelect.addEventListener('change', () => {
      selectMidiDevice(midiDeviceSelect.value);
    });
    
    midiRefreshBtn.addEventListener('click', () => {
      refreshMidiDevices();
    });
    
    // 不重复随机数量变化事件
    nonRepeatSlider.addEventListener('input', () => {
      nonRepeatProps.count = parseInt(nonRepeatSlider.value);
      updateNonRepeatValueDisplay();
      updateNonRepeatHistoryDisplay();
      
      // 如果不重复数量设置为0，清空历史记录
      if (nonRepeatProps.count === 0) {
        nonRepeatProps.history = [];
        updateNonRepeatHistoryDisplay();
      }
    });
    
    nonRepeatInput.addEventListener('input', () => {
      let value = parseInt(nonRepeatInput.value);
      if (isNaN(value)) value = 0;
      if (value < 0) value = 0;
      if (value > nonRepeatProps.maxCount) value = nonRepeatProps.maxCount;
      nonRepeatInput.value = value;
      nonRepeatSlider.value = value;
      nonRepeatProps.count = value;
      updateNonRepeatValueDisplay();
      updateNonRepeatHistoryDisplay();
      
      // 如果不重复数量设置为0，清空历史记录
      if (nonRepeatProps.count === 0) {
        nonRepeatProps.history = [];
        updateNonRepeatHistoryDisplay();
      }
    });
    
    // 随机范围变化时更新不重复随机数量的最大值
    minPositionSelect.addEventListener('change', () => {
      randomRangeProps.minIndex = parseInt(minPositionSelect.value);
      updateNonRepeatMaxCount();
      randomMoveNote(); // 设置后立即执行一次随机
    });
    
    maxPositionSelect.addEventListener('change', () => {
      randomRangeProps.maxIndex = parseInt(maxPositionSelect.value);
      updateNonRepeatMaxCount();
      randomMoveNote(); // 设置后立即执行一次随机
    });
    
    let randomBtnProps = {
      isDragging: false,
      offsetX: 0,
      offsetY: 0,
      initialX: 0,
      initialY: 0
    };
    
    // 随机按钮事件监听
    randomNoteBtn.addEventListener('mousedown', startRandomBtnDrag);
    randomNoteBtn.addEventListener('touchstart', startRandomBtnDrag);
    
    function startRandomBtnDrag(e) {
      e.preventDefault();
      randomBtnProps.isDragging = true;
      
      const rect = randomNoteBtn.getBoundingClientRect();
      if (e.type === 'mousedown') {
        randomBtnProps.offsetX = e.clientX - rect.left;
        randomBtnProps.offsetY = e.clientY - rect.top;
      } else {
        const touch = e.touches[0];
        randomBtnProps.offsetX = touch.clientX - rect.left;
        randomBtnProps.offsetY = touch.clientY - rect.top;
      }
      
      randomBtnProps.initialX = parseInt(randomNoteBtn.style.right || '16');
      randomBtnProps.initialY = parseInt(randomNoteBtn.style.bottom || '16');
      
      document.addEventListener('mousemove', dragRandomBtn);
      document.addEventListener('touchmove', dragRandomBtn);
      document.addEventListener('mouseup', endRandomBtnDrag);
      document.addEventListener('touchend', endRandomBtnDrag);
    }
    
    function dragRandomBtn(e) {
      if (!randomBtnProps.isDragging) return;
      e.preventDefault();
      
      let clientX, clientY;
      if (e.type === 'mousemove') {
        clientX = e.clientX;
        clientY = e.clientY;
      } else {
        const touch = e.touches[0];
        clientX = touch.clientX;
        clientY = touch.clientY;
      }
      
      const containerRect = canvas.parentElement.getBoundingClientRect();
      const btnRect = randomNoteBtn.getBoundingClientRect();
      
      const newRight = containerRect.right - clientX - randomBtnProps.offsetX;
      const newBottom = containerRect.bottom - clientY - randomBtnProps.offsetY;
      
      // 限制在容器范围内
      const maxRight = containerRect.width - btnRect.width - 16;
      const maxBottom = containerRect.height - btnRect.height - 16;
      
      randomNoteBtn.style.right = `${Math.max(16, Math.min(newRight, maxRight))}px`;
      randomNoteBtn.style.bottom = `${Math.max(16, Math.min(newBottom, maxBottom))}px`;
    }
    
    function endRandomBtnDrag(e) {
      if (!randomBtnProps.isDragging) return;
      
      // 检查是否是点击（移动距离很小）
      const moved = Math.abs(parseInt(randomNoteBtn.style.right) - randomBtnProps.initialX) > 5 || 
                    Math.abs(parseInt(randomNoteBtn.style.bottom) - randomBtnProps.initialY) > 5;
      
      if (!moved) {
        // 如果是点击，执行随机音符
        randomMoveNote();
      }
      
      randomBtnProps.isDragging = false;
      document.removeEventListener('mousemove', dragRandomBtn);
      document.removeEventListener('touchmove', dragRandomBtn);
      document.removeEventListener('mouseup', endRandomBtnDrag);
      document.removeEventListener('touchend', endRandomBtnDrag);
    }
    
    // 重置按钮事件
    linesResetBtn.addEventListener('click', () => {
      spacingSlider.value = 25;
      positionSlider.value = 195;
      thicknessSlider.value = 2;
      lengthSlider.value = 80;
      colorPicker.value = '#000000';
      snapEnabledCheckbox.checked = true;
      snapStrengthSlider.value = 25;
      snapProps.enabled = true;
      snapProps.strength = 25;
      updateLinesValueDisplay();
      drawLines();
    });
    
    clefResetBtn.addEventListener('click', () => {
      clefSizeSlider.value = 55;
      showClefCheckbox.checked = true;
      clefAutoSnapCheckbox.checked = true;
      clefProps.size = 55;
      clefProps.show = true;
      clefProps.autoSnap = true;
      updateClefValueDisplay();
      drawLines();
    });
    
    noteResetBtn.addEventListener('click', () => {
      noteXSlider.value = 400;
      noteYSlider.value = 200;
      noteSizeSlider.value = 8;
      showNoteCheckbox.checked = true;
      noteProps.x = 400;
      noteProps.y = 200;
      noteProps.size = 8;
      noteProps.show = true;
      updateNoteValueDisplay();
      drawLines();
    });
    
    textResetBtn.addEventListener('click', () => {
      textColorPicker.value = '#000000';
      textSizeSlider.value = 19;
      textFontSelect.value = 'Arial, sans-serif';
      showPositionDisplayCheckbox.checked = true;
      showRandomButtonCheckbox.checked = true;
      showNonRepeatHistoryCheckbox.checked = true;
      textProps.color = '#000000';
      textProps.size = 19;
      textProps.font = 'Arial, sans-serif';
      textProps.showPositionDisplay = true;
      textProps.showRandomButton = true;
      textProps.showNonRepeatHistory = true;
      updateTextValueDisplay();
      updatePositionDisplayStyle();
      updateRandomButtonDisplay();
      updateNonRepeatHistoryDisplay();
    });
    
    pianoResetBtn.addEventListener('click', () => {
      showPianoCheckbox.checked = true;
      pianoHeightSlider.value = 150;
      pianoPositionSlider.value = 0;
      pianoHorizontalSlider.value = 0;
      pianoKeyWidthSlider.value = 40;
      pianoGroupsSlider.value = 7;
      showAllNamesCheckbox.checked = true;
      showOnlyCentralCCheckbox.checked = false;
      enablePinchZoomCheckbox.checked = true;
      pianoProps.show = true;
      pianoProps.height = 150;
      pianoProps.position = 0;
      pianoProps.horizontal = 0;
      pianoProps.keyWidth = 40;
      pianoProps.groups = 7;
      pianoProps.showAllNames = true;
      pianoProps.showOnlyCentralC = false;
      pianoProps.enablePinchZoom = true;
      pianoProps.scale = 1;
      updatePianoValueDisplay();
      updatePianoHeight();
      updatePianoPosition();
      updatePianoKeyWidth();
      updatePianoGroups();
      pianoContainer.style.display = 'block';
      drawPiano();
    });
    
    randomRangeResetBtn.addEventListener('click', () => {
      minPositionSelect.value = '-16';
      maxPositionSelect.value = '24';
      randomRangeProps.minIndex = -16;
      randomRangeProps.maxIndex = 24;
      
      // 重置不重复随机数量
      nonRepeatSlider.value = 0;
      nonRepeatInput.value = 0;
      nonRepeatProps.count = 0;
      nonRepeatProps.history = [];
      
      updateNonRepeatValueDisplay();
      updateNonRepeatMaxCount();
      updateNonRepeatHistoryDisplay();
      randomMoveNote(); // 重置后立即执行一次随机
    });
    
    // 绑定设置按钮点击事件
    settingsButton.addEventListener('click', toggleSettingsMenu);
    
    // 绑定模态框按钮事件
    linesSettingsBtn.addEventListener('click', openLinesModal);
    linesCloseBtn.addEventListener('click', closeLinesModal);
    clefSettingsBtn.addEventListener('click', openClefModal);
    clefCloseBtn.addEventListener('click', closeClefModal);
    noteSettingsBtn.addEventListener('click', openNoteModal);
    noteCloseBtn.addEventListener('click', closeNoteModal);
    textSettingsBtn.addEventListener('click', openTextModal);
    textCloseBtn.addEventListener('click', closeTextModal);
    pianoSettingsBtn.addEventListener('click', openPianoModal);
    pianoCloseBtn.addEventListener('click', closePianoModal);
    midiSettingsBtn.addEventListener('click', openMidiModal);
    midiCloseBtn.addEventListener('click', closeMidiModal);
    randomRangeBtn.addEventListener('click', openRandomRangeModal);
    randomRangeCloseBtn.addEventListener('click', closeRandomRangeModal);
    
    // 点击页面其他区域关闭下拉菜单
    document.addEventListener('click', (e) => {
      if (!settingsDropdown.contains(e.target)) {
        closeSettingsMenu();
      }
    });
    
    // 初始化显示值
    updateLinesValueDisplay();
    updateClefValueDisplay();
    updateNoteValueDisplay();
    updateTextValueDisplay();
    updatePianoValueDisplay();
    updateNonRepeatValueDisplay();
    
    // 初始化不重复随机数量的最大值
    updateNonRepeatMaxCount();
    
    // 初始绘制
    drawLines();
    drawPiano();
    updatePositionDisplayStyle();
    updateRandomButtonDisplay();
    updateNonRepeatHistoryDisplay();
    updatePianoPosition();
    updateMidiStatus();
  </script>
</body>
</html>
